<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GnosisSafeExplorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="GnosisSafeExplorer (c) Bok Consulting Pty Ltd 2025" />
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/dexie.js"></script>
    <script src="safeInfo.js"></script>
    <script src="globals.js"></script>
    <script src="chains.js"></script>
    <script src="customNames.js"></script>
    <script src="deploymentData.js"></script>
    <script src="inferTxInfo.js"></script>
    <script src="parseEtherscan.js"></script>
    <script src="parseReservoir.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="images/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="https://bokkypoobah.github.io/GnosisSafeExplorer/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/ZombieBaby_004_transparentbg_zoomed.png" v-b-popover.hover.bottom="'gm'" class="ml-0"></b-avatar>
            <font size="-1" v-b-popover.hover.bottom="'gm gm gm'">GnosisSafeExplorer</font>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-nav-item size="sm" @click="settings.page = 'safe'; saveSettings();" :active="settings.page == 'safe'" active-class="active" v-b-popover.hover="'Safe'">Safe</b-nav-item>
            <b-nav-item size="sm" @click="settings.page = 'safes'; saveSettings();" :active="settings.page == 'safes'" active-class="active" v-b-popover.hover="'All Safes created by factories 1.3.0 and 1.4.1'">Safes</b-nav-item>
            <!-- <b-avatar v-if="coinbase && coinbase != nameOrShortAddress(coinbase)" rounded variant="light" size="3.0rem" :src="'https://metadata.ens.domains/mainnet/avatar/' + nameOrShortAddress(coinbase, 100)" v-b-popover.hover="'Your ENS avatar if set'"></b-avatar> -->
            <!-- <b-button size="sm" variant="outline-primary" class="ml-1 mr-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover.bottom="'Click to update wallet'">{{ coinbase ? nameOrShortAddress(coinbase, 16) : 'Connect' }}</b-button> -->
            <b-button size="sm" variant="outline-primary" class="ml-5 mr-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover.bottom="'Click to update wallet'">{{ coinbase ? coinbase.substring(0, 16) : 'Connect' }}</b-button>
          </b-navbar-nav>
        </b-navbar>

        <!-- <b-alert v-if="false" size="sm" dismissible variant="warning" show class="m-1 my-0">
          Warning: This is experimental unaudited software. Please check your transaction data carefully before signing
        </b-alert> -->
        <!-- <b-card class="m-2 p-1" header-class="warningheader" header="Welcome" v-if="false && !coinbase">
          <b-card-text>
            Please install the MetaMask extension and connect to the Ethereum Mainnet or an EVM compatible chain. Then refresh this page, and click the [Connect] button on the top right.
          </b-card-text>
        </b-card> -->

        <b-modal id="modal-methodid" hide-footer size="lg" body-class="m-0 p-3" body-bg-variant="light">
          <template #modal-title>
            Method Id {{ modalMethodId.methodId }}
            <font size="-1" class="text-muted ml-2">{{ modalMethodId.contract }}</font>
          </template>
          <b-form-group label="Contract:" label-cols="3" label-align="right" description="Browse this link. Click on [Contract]. If available, click on [Read As Proxy], then click on the ABI implementation link. Copy the contract ABI and paste below">
            <b-input-group>
              <b-button v-if="modalMethodId.contract" :href="'https://etherscan.io/address/' + lookupAddress(modalMethodId.contract)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                {{ modalMethodId.contract }}
              </b-button>
              <b-input-group-append>
                <b-button size="sm" @click="copyToClipboard(lookupAddress(modalMethodId.contract));" variant="link">
                  <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                </b-button>
              </b-input-group-append>
            </b-input-group>
          </b-form-group>
          <b-form-group label="ABI:" label-cols="3" label-align="right">
            <b-form-textarea v-model="modalMethodId.abi" rows="6" max-rows="10" placeholder="Paste the ABI (Application Binary Interface) here"></b-form-textarea>
          </b-form-group>
          <b-form-group label="Function:" label-cols="3" label-align="right">
            <b-form-textarea disabled :value="modalMethodId_search()" rows="3" max-rows="5" placeholder="Matching function will be displayed here"></b-form-textarea>
          </b-form-group>
          <b-form-group label="" label-cols="3" label-align="right">
            <b-button :disabled="!modalMethodId_search() || modalMethodId_search().substring(0, 3) == 'Not'" @click="modalMethodId_add()" variant="primary">Add</b-button>
          </b-form-group>
        </b-modal>

        <!-- TODO: Fill out - :MODALSAFEADDRESS -->
        <b-modal id="modal-safeaddress" hide-footer size="lg" body-class="m-0 p-1 pt-2" body-bg-variant="light">
          <template #modal-title>
            Address {{ modalSafeAddress.address }}
            <font size="-1" class="text-muted ml-2">{{ safe_lookupNameType(modalSafeAddress.address) }}</font>
            <!-- <b-badge pill variant="transparent" class="px-0">
            {{ safe_lookupNameType(modalSafeAddress.address) }}
            </b-badge> -->
          </template>
          <b-form-group label="Address:" label-cols="4" label-align="right" class="m-0 p-0">
            <b-input-group>
              <b-button v-if="modalSafeAddress.address" :href="'https://etherscan.io/address/' + lookupAddress(modalSafeAddress.address)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                {{ modalSafeAddress.address }}
              </b-button>
              <b-input-group-append>
                <b-button size="sm" @click="copyToClipboard(lookupAddress(modalSafeAddress.address));" variant="link">
                  <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                </b-button>
                <b-button v-if="modalSafeAddress.address && safe_lookupNameType(modalSafeAddress.address) == 'safe'" size="sm" :href="'https://app.safe.global/transactions/history?safe=eth:' + lookupAddress(modalSafeAddress.address)" v-b-popover.hover.bottom="'View in app.safe.global'" variant="link" target="_blank">
                  <b-icon-wallet shift-v="-1" font-scale="1.1"></b-icon-wallet>
                </b-button>
              </b-input-group-append>
            </b-input-group>
          </b-form-group>
          <b-form-group label="Name:" label-cols="4" label-align="right" class="m-0 p-0" description="Delete to use the default name">
            <b-form-input size="sm" :value="safe_lookupName(modalSafeAddress.address)" @change="safe_updateName(modalSafeAddress.address, $event);" class="w-50"></b-form-input>
          </b-form-group>
          <b-form-group label="Type:" label-cols="4" label-align="right" class="m-0 p-0">
            <b-form-select disabled size="sm" :value="safe_lookupNameType(modalSafeAddress.address)" :options="addressTypeOptions" class="w-50"></b-form-select>
            <b-button size="sm" @click="safe_toggleJunk(modalSafeAddress.address);" variant="transparent" v-b-popover.hover.ds500="settings.junk[modalSafeAddress.address] ? 'Junk' : 'Not junk'" class="m-0 ml-1 p-0">
              <b-icon :icon="settings.junk[modalSafeAddress.address] ? 'trash-fill' : 'trash'" font-scale="1.2" :variant="settings.junk[modalSafeAddress.address] ? 'primary' : 'secondary'"></b-icon>
            </b-button>
          </b-form-group>
          <b-form-group v-if="safe_lookupNameType(modalSafeAddress.address) == 'erc20'" label="Decimals:" label-cols="4" label-align="right" class="m-0 p-0" description="Delete to use the default decimals">
            <b-form-input size="sm" :value="safe_lookupDecimals(modalSafeAddress.address)" @change="safe_updateDecimals(modalSafeAddress.address, $event);" class="w-25"></b-form-input>
          </b-form-group>
        </b-modal>

        <!-- TODO: Fill out - :MODALSAFETX -->
        <b-modal id="modal-safetx" hide-footer size="lg" body-class="m-0 p-1 pt-2" body-bg-variant="light">
          <template #modal-title>
            Safe Tx
          </template>
          <font size="-2">
            <pre>
              {{ modalSafeTx }}
            </pre>
          </font>
        </b-modal>

        <!-- TODO: Delete - :MODALSAFE -->
        <b-modal id="modal-safe" hide-footer size="lg" body-class="m-0 p-1 pt-2" body-bg-variant="light">
          <template #modal-title>
            Safe {{ modalSafe.safe || '' }}
          </template>
          <b-form-group label="Safe:" label-cols="4" label-align="right" class="m-0 p-0">
            <b-input-group>
              <b-button v-if="modalSafe.safe" :href="'https://etherscan.io/address/' + lookupAddress(modalSafe.safe)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                {{ lookupName(modalSafe.safe) }}
              </b-button>
              <b-input-group-append>
                <b-button size="sm" @click="copyToClipboard(lookupAddress(modalSafe.safe));" variant="link">
                  <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                </b-button>
                <b-button v-if="modalSafe.safe" size="sm" :href="'https://app.safe.global/transactions/history?safe=eth:' + lookupAddress(modalSafe.safe)" v-b-popover.hover.bottom="'View in app.safe.global'" variant="link" target="_blank">
                  <b-icon-wallet shift-v="-1" font-scale="1.1"></b-icon-wallet>
                </b-button>
              </b-input-group-append>
            </b-input-group>
          </b-form-group>
          <b-form-group label="Factory:" label-cols="4" label-align="right" class="m-0 p-0" :description="modalSafe.info.factoryVersion && ('Safe Factory v' + modalSafe.info.factoryVersion) || ''">
            <b-input-group>
              <b-button v-if="modalSafe.factory" :href="'https://etherscan.io/address/' + lookupAddress(modalSafe.factory)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                {{ lookupName(modalSafe.factory) }}
              </b-button>
              <b-input-group-append>
                <b-button size="sm" @click="copyToClipboard(lookupAddress(modalSafe.factory));" variant="link">
                  <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                </b-button>
              </b-input-group-append>
            </b-input-group>
          </b-form-group>
          <b-form-group label="Safe Implementation:" label-cols="4" label-align="right" class="m-0 p-0" :description="modalSafe.info.safeVersion && ('Safe v' + modalSafe.info.safeVersion) || ''">
            <b-input-group>
              <b-button v-if="modalSafe.info.implementation" :href="'https://etherscan.io/address/' + lookupAddress(modalSafe.info.implementation)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                {{ lookupName(modalSafe.info.implementation) }}
              </b-button>
              <b-input-group-append>
                <b-button v-if="modalSafe.info.implementation" size="sm" @click="copyToClipboard(lookupAddress(modalSafe.info.implementation));" variant="link">
                  <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                </b-button>
              </b-input-group-append>
            </b-input-group>
          </b-form-group>
          <b-form-group label="Owners:" label-cols="4" label-align="right" class="m-0">
            <div v-for="(owner, index) of (modalSafe.info.owners || [])" v-bind:key="index">
              <b-input-group>
                <b-button :href="'https://etherscan.io/address/' + lookupAddress(owner)" variant="link" target="_blank" class="m-0 p-0 pt-1">
                  {{ lookupName(owner) }}
                </b-button>
                <b-input-group-append>
                  <b-button size="sm" @click="copyToClipboard(lookupAddress(owner));" variant="link">
                    <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                  </b-button>
                </b-input-group-append>
              </b-input-group>
            </div>
          </b-form-group>
          <b-form-group label="Threshold:" label-cols="4" label-align="right" class="m-0">
            <b-form-input type="text" readonly size="sm" :value="modalSafe.info.threshold" class="w-25"></b-form-input>
          </b-form-group>
          <b-form-group label="Nonce:" label-cols="4" label-align="right" class="m-0">
            <b-form-input type="text" readonly size="sm" :value="modalSafe.info.nonce" class="w-25"></b-form-input>
          </b-form-group>
          <!-- :MENU -->
          <div class="d-flex flex-wrap m-0 mt-1 p-0 px-1 pt-1 bg-white">
            <!-- <div class="mt-0 pr-1" style="max-width: 24.0rem;">
              <b-form-input type="text" size="sm" v-model.trim="settings.safeTxsTable.filter" @change="saveSettings(); loadCurrentData();" debounce="600" v-b-popover.hover.bottom="'Filter by safe address'" placeholder="🔍 0xabcd"></b-form-input>
            </div> -->
            <div class="mt-0 flex-grow-1">
            </div>
            <!-- <b-progress v-if="sync.section != null" height="2.0rem" :max="sync.total" show-progress :animated="sync.section != null" :variant="sync.section != null ? 'success' : 'secondary'" class="m-0 p-0" style="min-width: 24.0rem;">
              <b-progress-bar :value="sync.completed">
                {{ sync.total == null ? (sync.completed + ' ' + sync.section) : (sync.completed + '/' + sync.total + ' ' + ((sync.completed / sync.total) * 100).toFixed(0) + '% ' + sync.section) }}
              </b-progress-bar>
            </b-progress> -->
            <!-- <div class="mt-0 flex-grow-1">
            </div> -->
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safeTxsTable.sortOption" @change="saveSettings" :options="safeTxsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
            </div>
            <!-- <div class="mt-0 pl-1">
              <font size="-2" v-b-popover.hover.bottom="'# Safes'">{{ modalSafeTxs.length }}</font>
            </div> -->
            <!-- <div class="mt-0 pl-1">
              <b-pagination size="sm" v-model="settings.safeTxsTable.currentPage" @input="saveSettings" :total-rows="modalSafeTxs.length" :per-page="settings.safeTxsTable.pageSize" style="height: 0;"></b-pagination>
            </div> -->
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safeTxsTable.pageSize" @change="saveSettings" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
            </div>
          </div>
          <!-- <b-table ref="safeTxsTable" small fixed striped responsive hover selectable select-mode="single" @row-selected='safesRowSelected' :fields="safesFields" :items="pagedFilteredSortedSafes" show-empty empty-html="Click Sync above to retrieve all deployed Safes v1.1.1, v1.3.0 and v1.4.1" head-variant="light" class="mx-0 my-0"> -->
          <!-- <b-table ref="safeTxsTable" small fixed striped responsive hover :fields="safeTxsFields" :items="pagedFilteredSortedSafeTxs" show-empty empty-html="Retrieving..." head-variant="light" class="mx-0 mt-1">
            <template #cell(index)="data">
              <font size="-1" class="text-muted">
                {{ parseInt(data.index) + ((settings.safeTxsTable.currentPage - 1) * settings.safeTxsTable.pageSize) + 1 }}
              </font>
            </template>
            <template #cell(info)="data">
              <b-link :href="'https://etherscan.io/tx/' + data.item.txHash" target="_blank">
                {{ timestamps[chainId] && timestamps[chainId][data.item.blockNumber] && formatTimestamp(timestamps[chainId][data.item.blockNumber]) || (data.item.blockNumber + ':' + data.item.txIndex) }}
              </b-link>
              <br />
              From:
              <b-link v-if="data.item.tx && data.item.tx.from" :href="'https://etherscan.io/address/' + lookupAddress(data.item.tx.from)" target="_blank">
                {{ lookupName(data.item.tx.from) }}
              </b-link>
              <br />
              To:
              <b-link v-if="data.item.tx && data.item.tx.to" :href="'https://etherscan.io/address/' + lookupAddress(data.item.tx.to)" target="_blank">
                {{ lookupName(data.item.tx.to) }}
              </b-link>
              <hr />
              <font size="-2">
                <pre>
                  {{ data.item }}
                </pre>
              </font>
            </template>
          </b-table> -->
        </b-modal>

        <b-card no-body class="p-0 mt-0 border-0" style="min-height: 600px;">
          <!-- :SAFEMENU -->
          <b-tabs v-if="settings.page == 'safe'" v-model="settings.tabIndex" @input="saveSettings" align="right" class="text-right mt-1" content-class="m-0 p-0">
            <template #tabs-start>
              <div class="d-flex flex-grow-1">
                <div class="ml-1 mt-1 p-0" style="width: 24.0rem;">
                  <b-form-input :disabled="!!sync.section" type="text" size="sm" v-model.trim="settings.safe" @change="saveSettings(); syncSafe();" debounce="600" v-b-popover.hover.bottom="'Exact safe address'" placeholder="🔍 Exact Gnosis Safe address, e.g., 0x1234...abcd"></b-form-input>
                </div>
                <div class="mt-1 pr-1">
                  <b-dropdown :disabled="!!sync.section" size="sm" right text="" variant="link" class="m-0 p-0">
                    <b-dropdown-text>Sample Safes</b-dropdown-text>
                    <b-dropdown-divider></b-dropdown-divider>
                    <b-dropdown-item @click="settings.safe = '0x9fC3dc011b461664c835F2527fffb1169b3C213e'; saveSettings(); syncSafe();">EF: DeFi Multisig - Safe v1.4.1</b-dropdown-item>
                    <b-dropdown-item @click="settings.safe = '0x1Db92e2EeBC8E0c075a02BeA49a2935BcD2dFCF4'; saveSettings(); syncSafe();">Hacked Bybit: Cold Wallet 1 - Originally Safe 1.3.0; now Non-Safe Contract</b-dropdown-item>
                  </b-dropdown>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div v-if="!sync.section" class="mt-1 pr-1">
                  <b-button size="sm" @click="syncSafe()" variant="primary" v-b-popover.hover.bottom="'Sync Safe events'">Sync</b-button>
                </div>
                <div v-if="!sync.section" class="mt-2 pr-1">
                  <b-form-checkbox size="sm" v-model="settings.devMode" @input="saveSettings();" v-b-popover.hover="'Dev Mode?'">Dev</b-form-checkbox>
                </div>
                <div v-if="sync.section != null" class="mt-1 pr-1">
                  <b-progress height="2.0rem" :max="sync.total" show-progress :animated="sync.section != null" :variant="sync.section != null ? 'success' : 'secondary'" class="m-0 p-0" style="min-width: 18.0rem;">
                    <b-progress-bar :value="sync.completed">
                      {{ sync.total == null ? (sync.completed + ' ' + sync.section) : (sync.completed + '/' + sync.total + ' ' + ((sync.completed / sync.total) * 100).toFixed(0) + '% ' + sync.section) }}
                    </b-progress-bar>
                  </b-progress>
                </div>
                <div v-if="sync.section != null" class="ml-0 mt-2">
                  <b-button size="sm" @click="halt" variant="link" v-b-popover.hover.top="'Click to stop. This process can be continued later'"><b-icon-stop-fill shift-v="+1" font-scale="1.0"></b-icon-stop-fill></b-button>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
            </div>
            </template>
            <b-tab title="Safe" no-body></b-tab>
            <!-- <b-tab disabled title="Fungibles" no-body></b-tab> -->
            <!-- <b-tab disabled title="Non-Fungibles" no-body></b-tab> -->
            <b-tab title="Transactions" no-body></b-tab>
          </b-tabs>

          <div v-if="settings.page == 'safe' && settings.tabIndex == 1" class="d-flex flex-wrap m-0 mt-1 p-0 px-1 bg-white">
            <!-- <div class="mt-0 pr-1" style="min-width: 24.0rem; max-width: 24.0rem;">
              <b-form-input type="text" size="sm" v-model.trim="settings.safe" @change="saveSettings(); syncSafe();" debounce="600" v-b-popover.hover.bottom="'Exact safe address'" placeholder="🔍 0xabcd"></b-form-input>
            </div> -->
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pr-1">
              <b-dropdown size="sm" variant="link" v-b-popover.hover.ds500="'Junk filter'">
                <template #button-content>
                  <span v-if="settings.safeTxsTable.junkFilter == 'excludejunk'">
                    <b-iconstack font-scale="1">
                      <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                      <b-icon stacked icon="slash-circle" variant="danger"></b-icon>
                    </b-iconstack>
                  </span>
                  <span v-else-if="settings.safeTxsTable.junkFilter == null">
                    <b-iconstack font-scale="1">
                      <b-icon stacked icon="circle-fill" variant="warning"></b-icon>
                      <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                    </b-iconstack>
                  </span>
                  <span v-else>
                    <b-iconstack font-scale="1">
                      <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                    </b-iconstack>
                  </span>
                </template>
                <b-dropdown-item href="#" @click="settings.safeTxsTable.junkFilter = 'excludejunk'; saveSettings()">
                  <b-iconstack font-scale="1">
                    <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                    <b-icon stacked icon="slash-circle" variant="danger"></b-icon>
                  </b-iconstack>
                  Exclude Junk
                </b-dropdown-item>
                <b-dropdown-item href="#" @click="settings.safeTxsTable.junkFilter = null; saveSettings()">
                  <b-iconstack font-scale="1">
                    <b-icon stacked icon="circle-fill" variant="warning"></b-icon>
                    <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                  </b-iconstack>
                  Include Junk
                </b-dropdown-item>
                <b-dropdown-item href="#" @click="settings.safeTxsTable.junkFilter = 'junk'; saveSettings()">
                  <b-iconstack font-scale="1">
                    <b-icon stacked icon="trash" variant="info" scale="0.75"></b-icon>
                  </b-iconstack>
                  Junk
                </b-dropdown-item>
              </b-dropdown>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div v-if="safe[3]" class="mt-0 pr-1">
              <font size="+1">
                <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'Threshold. Click to view Safe in the explorer'">
                  <b-link :href="'https://etherscan.io/address/' + safe[0]" target="_blank" >
                    {{ safe[3] }}
                  </b-link>
                </b-badge>
              </font>
            </div>
            <div v-if="safe[2]" class="mt-0 pr-1">
              <font size="-1" class="text-muted">
                /
              </font>
              <font size="+1">
                <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'# Owners. Click to view Safe in app.safe.global'">
                  <b-link :href="'https://app.safe.global/transactions/history?safe=eth:' + safe[0]" target="_blank" >
                    {{ safe[2].length }}
                  </b-link>
                </b-badge>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div v-if="safe[2]" class="mt-0 pr-1">
              <span v-for="(owner, index) of safe[2]" v-bind:key="index">
                <font v-if="index > 0" size="-1" class="text-muted">
                  ,
                </font>
                <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View owner #' + (index + 1) + ' in the explorer'">
                  <b-link :href="'https://etherscan.io/address/' + owners[owner[0]]" target="_blank">
                    <font size="-1">{{ owners[owner[0]].substring(0, 8) }}</font>
                  </b-link>
                </b-badge>
              </span>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safeTxsTable.sortOption" @change="saveSettings" :options="safeTxsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
            </div>
            <div class="mt-0 pl-1">
              <font size="-2" v-b-popover.hover.bottom="'# Transaction'">{{ filteredSortedSafeTxs.length }}</font>
            </div>
            <div class="mt-0 pl-1">
              <b-pagination size="sm" v-model="settings.safeTxsTable.currentPage" @input="saveSettings" :total-rows="filteredSortedSafeTxs.length" :per-page="settings.safeTxsTable.pageSize" style="height: 0;"></b-pagination>
            </div>
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safeTxsTable.pageSize" @change="saveSettings" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
            </div>
          </div>

          <!-- :SAFESMENU -->
          <div v-if="settings.page == 'safes'" class="d-flex flex-wrap m-0 mt-1 p-0 px-1 bg-white">
            <div class="mt-0 pr-1" style="max-width: 24.0rem;">
              <b-form-input type="text" size="sm" v-model.trim="settings.safesTable.filter" @change="saveSettings();" debounce="600" v-b-popover.hover.bottom="'Filter by safe address'" placeholder="🔍 0xabcd"></b-form-input>
            </div>
            <div class="mt-0 pr-1">
              <b-dropdown size="sm" right text="" variant="link" class="m-0 p-0">
                <b-dropdown-text>Sample Safes</b-dropdown-text>
                <b-dropdown-divider></b-dropdown-divider>
                <b-dropdown-item @click="settings.safesTable.filter = '0x9fC3dc011b461664c835F2527fffb1169b3C213e'; saveSettings();">EF: DeFi Multisig - Safe v1.4.1</b-dropdown-item>
                <b-dropdown-item @click="settings.safesTable.filter = '0x1Db92e2EeBC8E0c075a02BeA49a2935BcD2dFCF4'; saveSettings();">Hacked Bybit: Cold Wallet 1 - Originally Safe 1.3.0; now Non-Safe Contract</b-dropdown-item>
              </b-dropdown>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div v-if="!sync.section" class="mt-0 pr-1">
              <b-button size="sm" @click="syncAllSafesEvents()" variant="primary" v-b-popover.hover.bottom="'Retrieve Safe events'">Sync</b-button>
            </div>
            <div v-if="!sync.section" class="mt-1 pr-1">
              <b-form-checkbox size="sm" v-model="settings.devMode" @input="saveSettings();" v-b-popover.hover="'Dev Mode?'">Dev</b-form-checkbox>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div v-if="!sync.section" class="mt-0 pr-1">
              <b-button size="sm" @click="resetData()" variant="primary" v-b-popover.hover.bottom="'Reset data'">Reset Data</b-button>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div v-if="sync.section != null" class="mt-0 pr-1">
              <b-progress height="2.0rem" :max="sync.total" show-progress :animated="sync.section != null" :variant="sync.section != null ? 'success' : 'secondary'" class="m-0 p-0" style="min-width: 24.0rem;">
                <b-progress-bar :value="sync.completed">
                  {{ sync.total == null ? (sync.completed + ' ' + sync.section) : (sync.completed + '/' + sync.total + ' ' + ((sync.completed / sync.total) * 100).toFixed(0) + '% ' + sync.section) }}
                </b-progress-bar>
              </b-progress>
            </div>
            <div v-if="sync.section != null" class="ml-0 mt-1">
              <b-button size="sm" @click="halt" variant="link" v-b-popover.hover.top="'Click to stop. This process can be continued later'"><b-icon-stop-fill shift-v="+1" font-scale="1.0"></b-icon-stop-fill></b-button>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safesTable.sortOption" @change="saveSettings" :options="safesSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
            </div>
            <div class="mt-0 pl-1">
              <font size="-2" v-b-popover.hover.bottom="'# Filtered / Safes'">{{ filteredSortedSafes.length + ' / ' + safes.length }}</font>
            </div>
            <div class="mt-0 pl-1">
              <b-pagination size="sm" v-model="settings.safesTable.currentPage" @input="saveSettings" :total-rows="safes.length" :per-page="settings.safesTable.pageSize" style="height: 0;"></b-pagination>
            </div>
            <div class="mt-0 pl-1">
              <b-form-select size="sm" v-model="settings.safesTable.pageSize" @change="saveSettings" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
            </div>
          </div>

          <!-- :SAFEPAGES -->
          <b-card v-if="settings.page == 'safe' && settings.tabIndex == 0" no-body class="m-1 p-0 border-0" bg-variant="light">
            <b-row>
              <b-col cols="8">
                <b-form-group v-if="settings.safe" label="Address:" label-cols="3" label-align="right" class="m-0 p-0" :description="safeData.version ? ('Version ' + safeData.version) : ''">
                  <b-input-group>
                    <b-button :href="'https://etherscan.io/address/' + lookupAddress(settings.safe)" variant="link" target="_blank" class="m-0 p-0 pt-1 text-left" style="width: 26.0rem;">
                      {{ settings.safe }}
                    </b-button>
                    <b-input-group-append>
                      <b-button size="sm" @click="copyToClipboard(lookupAddress(settings.safe));" variant="link">
                        <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                      </b-button>
                      <font size="-1" class="mt-2 ml-5 text-muted">
                        <b-link @click="viewAddress(settings.safe)">
                          {{ safe_lookupName(settings.safe) }}
                        </b-link>
                      </font>
                      <b-button v-if="safe_lookupNameType(settings.safe) == 'safe'" size="sm" :href="'https://app.safe.global/transactions/history?safe=eth:' + lookupAddress(settings.safe)" v-b-popover.hover.bottom="'View in app.safe.global'" variant="link" target="_blank">
                        <b-icon-wallet shift-v="-1" font-scale="1.1"></b-icon-wallet>
                      </b-button>
                    </b-input-group-append>
                  </b-input-group>
                </b-form-group>
                <b-form-group v-if="settings.safe == safeData.address && Object.keys(safeData.owners || {}).length > 0" label="Owners:" label-cols="3" label-align="right" class="m-0">
                  <div v-for="(ownerIndex, owner, index) in safeData.owners" v-bind:key="ownerIndex">
                    <!-- owner: {{ owner }} index: {{ index }} ownerIndex: {{ ownerIndex }} -->
                    <b-input-group>
                      <b-button :href="'https://etherscan.io/address/' + owner" variant="link" target="_blank" class="m-0 p-0 pt-1 text-left" style="width: 26.0rem;">
                        <!-- {{ safe_lookupName(owner) }} -->
                        {{ owner }}
                      </b-button>
                      <b-input-group-append>
                        <b-button size="sm" @click="copyToClipboard(owner);" variant="link">
                          <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                        </b-button>
                        <font size="-1" class="mt-2 ml-5 text-muted">
                          <b-link @click="viewAddress(owner)">
                            {{ safe_lookupName(owner) }}
                          </b-link>
                        </font>
                      </b-input-group-append>
                    </b-input-group>
                  </div>
                </b-form-group>
                <b-form-group v-if="settings.safe == safeData.address && safeData.threshold" label="Threshold:" label-cols="3" label-align="right" class="m-0">
                  <b-form-input type="text" readonly size="sm" :value="safeData.threshold" class="w-25"></b-form-input>
                </b-form-group>
                <b-form-group v-if="settings.safe == safeData.address && safeData.nonce" label="Nonce:" label-cols="3" label-align="right" class="m-0">
                  <b-form-input type="text" readonly size="sm" :value="safeData.nonce" class="w-25"></b-form-input>
                </b-form-group>
                <b-form-group v-if="settings.safe == safeData.address && safeData.implementation" label="Implementation:" label-cols="3" label-align="right" class="m-0 p-0" :description="safeData.factoryVersion ? ('Version ' + safeData.factoryVersion) : ''">
                  <b-input-group>
                    <b-button :href="'https://etherscan.io/address/' + safeData.implementation" variant="link" target="_blank" class="m-0 p-0 pt-1 text-left" style="width: 26.0rem;">
                      {{ safeData.implementation }}
                    </b-button>
                    <b-input-group-append>
                      <b-button size="sm" @click="copyToClipboard(safeData.implementation);" variant="link">
                        <b-icon-clipboard shift-v="-1" font-scale="1.1"></b-icon-clipboard>
                      </b-button>
                      <font size="-1" class="mt-2 ml-5 text-muted">
                        <b-link @click="viewAddress(safeData.implementation)">
                          {{ safe_lookupName(safeData.implementation) }}
                        </b-link>
                      </font>
                    </b-input-group-append>
                  </b-input-group>
                </b-form-group>
              </b-col>
              <b-col cols="4">

              </b-col>
            </b-row>
          </b-card>

          <b-card v-if="settings.page == 'safe' && settings.tabIndex == 1" no-body class="m-1 p-0 border-0" bg-variant="light">
            <b-table ref="safeTxsTable" small fixed striped responsive hover selectable select-mode="single" @row-selected='safeTxsRowSelected' :fields="safeTxsFields" :items="pagedFilteredSortedSafeTxs" show-empty empty-html="Click Sync above to retrieve Safes deployed by Safe factories v1.0.0, v1.1.1, v1.3.0 and v1.4.1" head-variant="light" class="mx-0 my-0">
              <template #cell(index)="data">
                <font size="-1" class="text-muted">
                  {{ parseInt(data.index) + ((settings.safeTxsTable.currentPage - 1) * settings.safeTxsTable.pageSize) + 1 }}
                </font>
              </template>
              <template #cell(when)="data">
                <b-link :href="'https://etherscan.io/tx/' + data.item.txHash" target="_blank">
                  <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="'Unix timestamp: ' + data.item.timestamp">
                    {{ data.item.timestamp ? formatTimestamp(data.item.timestamp) : data.item.blockNumber }}
                  </b-badge>
                </b-link>
                <br />
                <font size="-2" class="text-muted" v-b-popover.hover.bottom="'[Block Number:] Transaction index'">
                  {{ data.item.timestamp ? (data.item.blockNumber + ':' + data.item.txIndex) : data.item.txIndex }}
                </font>
                <br />
                <font size="-2" class="text-muted" v-b-popover.hover.bottom="'Tx Hash'">
                  {{ data.item.txHash }}
                </font>
              </template>
              <template #cell(tx)="data">
                <div v-if="data.item.tx">
                  <font v-if="data.item.tx.from" size="-1" class="text-muted">
                    from
                  </font>
                  <b-badge v-if="data.item.tx.from" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + data.item.tx.from + ' in the explorer'">
                    <b-link @click="viewAddress(data.item.tx.from)">
                      <font size="-1">{{ safe_lookupName(data.item.tx.from) }}</font>
                    </b-link>
                  </b-badge>
                  <font v-if="data.item.tx.nonce" size="-1" class="text-muted">
                    nonce
                  </font>
                  <b-badge v-if="data.item.tx.nonce" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'From account nonce'">
                    <font size="-1">{{ data.item.tx.nonce }}</font>
                  </b-badge>
                  <font v-if="data.item.tx.to" size="-1" class="text-muted">
                    to
                  </font>
                  <b-badge v-if="data.item.tx.to" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + data.item.tx.to + ' in the explorer'">
                    <b-link @click="viewAddress(data.item.tx.to)">
                      <font size="-1">{{ safe_lookupName(data.item.tx.to) }}</font>
                    </b-link>
                  </b-badge>
                  <font v-if="data.item.tx.value" size="-1" class="text-muted">
                    value
                  </font>
                  <b-badge v-if="data.item.tx.value" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.tx.value">
                    {{ formatETH(data.item.tx.value, 0) }}
                  </b-badge>
                  <font v-if="data.item.tx.data.length > 2" size="-1" class="text-muted">
                    functionSig
                  </font>
                  <b-badge v-if="data.item.tx.data.length > 2" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.tx.value">
                    {{ data.item.tx.data.substring(0, 10) }}
                  </b-badge>
                </div>
                <div v-if="Object.keys(data.item.info).length > 0 && data.item.info.multisig">
                  <font v-if="data.item.info.multisig.from" size="-1" class="text-muted ml-2">
                    Multisig.execTransaction from
                  </font>
                  <b-badge v-if="data.item.info.multisig.from" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + data.item.info.multisig.from + ' in the explorer'">
                    <b-link @click="viewAddress(data.item.info.multisig.from)">
                      <font size="-1">{{ safe_lookupName(data.item.info.multisig.from) }}</font>
                    </b-link>
                  </b-badge>
                  <font v-if="data.item.info.multisig.to" size="-1" class="text-muted">
                    to
                  </font>
                  <b-badge v-if="data.item.info.multisig.to" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + data.item.info.multisig.to + ' in the explorer'">
                    <b-link @click="viewAddress(data.item.info.multisig.to)">
                      <font size="-1">{{ safe_lookupName(data.item.info.multisig.to) }}</font>
                    </b-link>
                  </b-badge>
                  <font v-if="data.item.info.multisig.value" size="-1" class="text-muted">
                    value
                  </font>
                  <b-badge v-if="data.item.info.multisig.value" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.value">
                    {{ formatETH(data.item.info.multisig.value, 0) }}
                  </b-badge>
                  <font v-if="data.item.info.multisig.data.length > 2" size="-1" class="text-muted">
                    functionSig
                  </font>
                  <b-badge v-if="data.item.info.multisig.data.length > 2" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.value">
                    {{ data.item.info.multisig.data.substring(0, 10) }}
                  </b-badge>
                  <font v-if="data.item.info.multisig.operation != null" size="-1" class="text-muted">
                    operation
                  </font>
                  <b-badge v-if="data.item.info.multisig.operation != null" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.operation">
                    {{ data.item.info.multisig.operation == 1 ? "DelegateCall" : "Call" }}
                  </b-badge>
                  <font v-if="data.item.info.multisig.nonce != null" size="-1" class="text-muted">
                    nonce
                  </font>
                  <b-badge v-if="data.item.info.multisig.nonce != null" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.nonce">
                    {{ data.item.info.multisig.nonce }}
                  </b-badge>
                  <br />
                  <font v-if="data.item.info.multisig.signers" size="-1" class="text-muted ml-3">
                    signers
                  </font>
                  <b-badge v-if="data.item.info.multisig.signers" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.signers">
                    <span v-for="(signer, signerIndex) of data.item.info.multisig.signers" v-bind:key="signerIndex">
                      <font v-if="signerIndex > 0" size="-1" class="text-muted">,</font>
                      <b-link @click="viewAddress(signer)">
                        <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + signer + ' in the explorer'">
                          <font size="-1">{{ safe_lookupName(signer) }}</font>
                        </b-badge>
                      </b-link>
                    </span>
                  </b-badge>
                  <br />
                  <font v-if="data.item.info.multisig.info.methodId" size="-1" class="text-muted ml-4">
                    methodId
                  </font>
                  <b-badge v-if="data.item.info.multisig.info.methodId" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.info.methodId">
                    <b-link @click="viewMethodId(data.item.info.multisig.info.methodId, data.item.info.multisig.data, data.item.info.multisig.to)">
                      {{ data.item.info.multisig.info.methodId }}
                    </b-link>
                  </b-badge>
                  <font v-if="data.item.info.multisig.info.action" size="-1" class="text-muted ml-4">
                    action
                  </font>
                  <b-badge v-if="data.item.info.multisig.info.action" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.info.action">
                    {{ data.item.info.multisig.info.action }}
                  </b-badge>
                  <span v-for="(parameter, parameterIndex) of data.item.info.multisig.info.parameters" v-bind:key="parameterIndex">
                    <!-- {{ parameter }} -->
                    <font size="-1" class="text-muted">
                      {{ parameter.name }}
                    </font>
                    <b-badge v-if="parameter.type == 'address'" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'Blah'">
                      <span v-if="parameter.value == 'eth'">
                        ETH
                      </span>
                      <span v-else>
                        <b-link @click="viewAddress(parameter.value)">
                          {{ safe_lookupName(parameter.value) }}
                        </b-link>
                      </span>
                    </b-badge>
                    <b-badge v-else-if="parameter.type == 'uint256'" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'Blah'">
                      <span v-if="parameter.name == 'value'">
                        {{ formatETH(parameter.value, 0) }}
                      </span>
                      <span v-else>
                        {{ parameter.value }}
                      </span>
                    </b-badge>
                    <b-badge v-else pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'Blah'">
                      {{ parameter.value }}
                    </b-badge>
                  </span>
                  <font v-if="!data.item.info.multisig.info.action" size="-1" class="text-muted ml-4">
                    data
                  </font>
                  <b-badge v-if="!data.item.info.multisig.info.action" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.info.multisig.data">
                    {{ data.item.info.multisig.data.substring(0, 20) + (data.item.info.multisig.data.length > 20 ? '...' : '') }}
                  </b-badge>
                </div>
                <b-row v-for="(safeLog, index) of data.item.safeLogs" v-bind:key="index">
                  <b-col cols="3" class="text-right">
                    <b-badge pill variant="transparent" v-b-popover.hover.bottom="safeLog.address" class="m-0 p-0">
                      <b-link @click="viewAddress(safeLog.address)">
                        {{ safe_lookupName(safeLog.address) }}
                      </b-link>
                    </b-badge>
                    <b-button v-if="safeLog.address != safeData.address" size="sm" @click="safe_toggleJunk(safeLog.address);" variant="transparent" v-b-popover.hover.ds500="settings.junk[safeLog.address] ? 'Junk' : 'Not junk'" class="m-0 p-0">
                      <b-icon :icon="settings.junk[safeLog.address] ? 'trash-fill' : 'trash'" font-scale="0.9" shift-v="+1" :variant="settings.junk[safeLog.address] ? 'primary' : 'secondary'" class="m-0 p-0"></b-icon>
                    </b-button>
                    <font size="-1" class="m-0 p-0 text-muted">
                      {{ safe_lookupNameType(safeLog.address) }}
                    </font>
                  </b-col>
                  <b-col cols="3">
                    <b-link :href="'https://etherscan.io/tx/' + data.item.txHash + '#eventlog#' + safeLog.logIndex" target="_blank">
                      <b-badge pill variant="transparent" v-b-popover.hover.bottom="'View ' + safeLog.signature + ' in the explorer'">
                        {{ safeLog.name }}
                      </b-badge>
                    </b-link>
                    <font size="-2" class="text-muted" v-b-popover.hover.bottom="'Log index'">{{ safeLog.logIndex }}</font>
                  </b-col>
                  <b-col cols="6">
                    <span v-for="(parameter, parameterIndex) of safeLog.parameters" v-bind:key="parameterIndex">
                      <font size="-1" class="text-muted">
                        {{ parameter.name }}
                      </font>
                      <b-badge v-if="parameter.type == 'address'" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + parameter.value + ' in the explorer'">
                        <b-link @click="viewAddress(parameter.value)">
                          <font size="-1">{{ safe_lookupName(parameter.value) }}</font>
                        </b-link>
                      </b-badge>
                      <span v-else-if="parameter.type == 'address[]'">
                        <span v-for="(address, addressIndex) of parameter.value" v-bind:key="addressIndex">
                          <font v-if="addressIndex > 0" size="-1" class="text-muted">,</font>
                          <b-link @click="viewAddress(address)">
                            <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + address + ' in the explorer'">
                              <font size="-1">{{ safe_lookupName(address) }}</font>
                            </b-badge>
                          </b-link>
                        </span>
                      </span>
                      <span v-else-if="parameter.name == 'txHash'">
                        <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="parameter.value">
                          {{ parameter.value.substring(0, 12) + '...' + parameter.value.slice(-10) }}
                        </b-badge>
                      </span>
                      <span v-else-if="parameter.name == 'value'">
                        <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="parameter.type">
                          {{ formatETH(parameter.value, 0) }}
                        </b-badge>
                      </span>
                      <span v-else-if="parameter.name == 'tokens'">
                        <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="parameter.type">
                          {{ formatDecimals(parameter.value, safeData.tokens[safeLog.address] && safeData.tokens[safeLog.address].decimals || 0) }}
                        </b-badge>
                      </span>
                      <span v-else>
                        <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="parameter.type">
                          {{ parameter.value }}
                        </b-badge>
                      </span>
                    </span>
                  </b-col>
                </b-row>
                <!-- <font v-if="Object.keys(data.item.info).length > 0" size="-2"> -->
                <!-- <font v-if="Object.keys(data.item.info).length > 0 && data.item.info.multisig" size="-2">
                  <pre>
                    {{ data.item.info }}
                  </pre>
                </font> -->
              </template>
              <template #cell(balance)="data">
                {{ formatETH(data.item.balance, 0) }}
              </template>
              <template #cell(event)="data">
                <b-badge variant="transparent" class="px-0" v-b-popover.hover.bottom="data.item.signature">
                  {{ data.item.name }}
                </b-badge>
              </template>
              <template #cell(parameters)="data">
                <div v-for="(parameter, index) of data.item.parameters" v-bind:key="index">
                  <font size="-1" class="text-muted">
                    {{ parameter.name }}
                  </font>
                  <b-badge v-if="parameter.type == 'address'" pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + parameter.value + ' in the explorer'">
                    <b-link :href="'https://etherscan.io/address/' + parameter.value" target="_blank">
                      <font size="-1">{{ parameter.value }}</font>
                    </b-link>
                  </b-badge>
                  <span v-else-if="parameter.type == 'address[]'">
                    <span v-for="(address, addressIndex) of parameter.value" v-bind:key="addressIndex">
                      <font v-if="addressIndex > 0" size="-1" class="text-muted">
                        ,
                      </font>
                      <b-badge pill variant="transparent" class="px-0" v-b-popover.hover.bottom="'View ' + address + ' in the explorer'">
                        <b-link :href="'https://etherscan.io/address/' + address" target="_blank">
                          <font size="-1">{{ address.substring(0, 8) }}</font>
                        </b-link>
                      </b-badge>
                    </span>
                  </span>
                  <b-badge v-else variant="transparent" class="px-0" v-b-popover.hover.bottom="parameter.type">
                    {{ parameter.value }}
                  </b-badge>
                </div>
              </template>
              <template #cell(blockNumber)="data">
                <b-link :href="'https://etherscan.io/tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" target="_blank">
                  {{ data.item.blockNumber }}
                </b-link>
                <font size="-2" class="text-muted">
                  {{ data.item.logIndex }}
                </font>
              </template>
            </b-table>
          </b-card>

          <!-- :SAFES -->
          <b-card v-if="settings.page == 'safes'" no-body class="m-1 p-0 border-0" bg-variant="light">
            <b-table ref="safesTable" small fixed striped responsive hover selectable select-mode="single" @row-selected='safesRowSelected' :fields="safesFields" :items="pagedFilteredSortedSafes" show-empty empty-html="Click Sync above to retrieve Safes deployed by Safe factories v1.0.0, v1.1.1, v1.3.0 and v1.4.1" head-variant="light" class="mx-0 my-0">
              <template #cell(index)="data">
                <font size="-1" class="text-muted">
                  {{ parseInt(data.index) + ((settings.safesTable.currentPage - 1) * settings.safesTable.pageSize) + 1 }}
                </font>
              </template>
              <template #cell(blockNumber)="data">
                <b-link :href="'https://etherscan.io/tx/' + txHashes[data.item[6]][0] + '#eventlog#' + data.item[8]" target="_blank">
                  {{ data.item[7] }}
                </b-link>
                <font size="-2" class="text-muted">
                  {{ data.item[8] }}
                </font>
              </template>
              <template #cell(safe)="data">
                <b-link :href="'https://etherscan.io/address/' + data.item[0]" target="_blank">
                  {{ data.item[0].substring(0, 10) + '...' + data.item[0].slice(-8) }}
                </b-link>
                <b-link :href="'https://app.safe.global/transactions/history?safe=eth:' + data.item[0]" v-b-popover.hover.bottom="'View in app.safe.global'" target="_blank">
                  <b-icon-wallet shift-v="+2" font-scale="0.9" variant="primary"></b-icon-wallet>
                </b-link>
              </template>
              <template #cell(owners)="data">
                <span v-for="(owner, index) of data.item[2]" v-bind:key="index">
                  <b-link :href="'https://etherscan.io/address/' + owners[owner[0]]" target="_blank" class="mr-2">
                    <font size="-1">{{ owners[owner[0]].substring(0, 6) + '...' + owners[owner[0]].slice(-4) }}</font>
                  </b-link>
                </span>
              </template>
              <template #cell(threshold)="data">
                {{ data.item[3] }}
              </template>
              <template #cell(factory)="data">
                <b-link :href="'https://etherscan.io/address/' + versionToFactories[data.item[1]]" target="_blank">
                  {{ data.item[1] }}
                </b-link>
              </template>
            </b-table>
          </b-card>

          <!-- :INFO -->
          <b-card v-if="false && (settings.mode == 'info' || (settings.mode == 'card' && Object.keys(settings.cards).length == 0))" no-body class="m-1 p-1 border-0" bg-variant="light">
            <b-card-body class="mt-1 p-1">
              <h6>Welcome to GnosisSafeExplorer (WIP)</h6>

              <!-- <br />

              1. Click [Connect] on the top right -->

              <br />
              <br />

              We are not affiliated with Gnosis .
              <!-- <br />
              <font size="-1">Enjoy!</font>
              <br />
              <font size="-1">(c) BokkyPooBah / Bok Consulting Pty Ltd 2025. The MIT Licence</font> -->
            </b-card-body>
          </b-card>
        </b-card>

        <b-card no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
          <div class="d-flex flex-wrap m-0 p-0">
            <div class="ml-0 mt-1 pl-1">
              <font v-if="connected" size="-2">
                <!-- <b-link v-if="coinbase" :href="'https://etherscan.io/address/' + coinbase" v-b-popover.hover.bottom="'Coinbase'" target="_blank">
                  {{ coinbase.substring(0, 10) }}
                </b-link> -->
                <b-link v-if="chainId" :href="'https://etherscan.io/'" v-b-popover.hover.bottom="'Network'" target="_blank">
                  {{ chainId == '1' ? 'Mainnet' : 'Unsupported' }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="'Latest block'" target="_blank">
                  {{ '#' + commify0(blockNumber) }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="formatTimestamp(timestamp)" target="_blank">
                  {{ formatTimeDiff(timestamp) }}
                </b-link>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1 pr-1">
              <font size="-1">
                gm, and enjoy! <i>GnosisSafeExplorer</i> &copy; Bok Consulting Pty Ltd 2025. The MIT Licence
              </font>
            </div>
          </div>
        </b-card>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {

          addresses: [],      // index => address
          addressesIndex: {}, // address => index
          txHashes: [],       // index => [ txHash, blockNumber, txIndex ]
          txHashesIndex: {},  // txHash => index
          owners: [],         // index => ownerAddress
          ownersIndex: {},    // ownerAddress => index
          safes: [],          // index => [ safeAddress, factoryVersion, [ ownerIndex,... ], threshold, [ removedOwnerIndex, ... ], proxyCreationFromFactoryVersion, txHashIndex, blockNumber, logIndex, latestTxHashIndex ]
          safesIndex: {},     // safeAddress => index

          safeData: {},       // blockNumber => { timestamp, txs: { ..., logs: { logIndex: eventData, ...} } }

          timestamps: {},     // TODO: Remove? blockNumber => Unix timestamp
          txData: {},         // TODO: Remove? Transactions only for the current safe address

          connected: false,
          chainId: null,
          coinbase: null,
          blockNumber: null,
          timestamp: null,

          settings: {
            page: 'safe',
            tabIndex: 0,
            devMode: false,
            safesTable: {
              filter: null,
              currentPage: 1,
              pageSize: 15,
              sortOption: 'blocknumberdsc',
            },
            safe: null,
            safeTxsTable: {
              filter: null,
              junkFilter: null,
              currentPage: 1,
              pageSize: 15,
              sortOption: 'blocknumberdsc',
            },
            names: {
              "0x9fC3dc011b461664c835F2527fffb1169b3C213e": "EF DeFi Multisig",
            },
            decimals: {},
            junk: {
              "0xE1ffdc4437992373809Fd7479F4B058E83A600a0": "HELLO",
              "0x1F316e894307285B2C503c677B75FB0B19560Df2": "ETHFNDN",
              "0xba386A4Ca26B85FD057ab1Ef86e3DC7BdeB5ce70": "JESUS",
              "0xD8E8438CF7bEEd13cFABC82F300Fb6573962c9e3": "HONK",
              "0xE5e63d22D23aB678CbD11dA11cFBfE1Ad3163584": "GROOT",
              "0x5b755c8b7B6eD28b3441121965cebdDE6266c4B6:0": "pooledether.com:0",
              "0x594DaaD7D77592a2b97b725A7AD59D7E188b5bFa": "APU",
              "0xD4F4D0a10BcaE123bB6655E8Fe93a30d01eEbD04": "LNQ",
              "0xe76C6c83af64e4C60245D8C7dE953DF673a7A33D": "RAIL",
              "0xf1df7305E4BAB3885caB5B1e4dFC338452a67891": "PALM",
              "0x06450dEe7FD2Fb8E39061434BAbCFC05599a6Fb8": "XEN",
              "0xCCBb7110D5a6DCFf236c293c78F9f47b078f20DD": "GEL",
              "0x9A594F5ed8D119B73525dfE23aDBCeCa77fD828D": "triangle",
              "0xb45ad160634c528Cc3D2926d9807104FA3157305": "sDOLA",
              "0xAD038Eb671c44b853887A7E32528FaB35dC5D710": "DBR",
              "0x08d23468A467d2bb86FaE0e32F247A26C7E2e994": "sINV",
              "0xEA024703eA43cFa1A01838F8fDBC41919d62360C": "SF",
              "0xb01dd87B29d187F3E3a4Bf6cdAebfb97F3D9aB98": "Bold",
              "0xe7DcC7620Eff0b4Df653001C3Fc696b9b57E5A7D": "WETH",
              "0x118a3603308A0d564E2b8db568B310e6BF05DfD3": "MEGA",
              "0x0000000000c5dc95539589fbD24BE07c6C14eCa4": "CULT",
              "0x5b755c8b7B6eD28b3441121965cebdDE6266c4B6": "pooledether.com",
              "0x24E161B9B028156aEEaA0852833FA10eDd774EbE": "MIYAGUCHI",
              "0x83D8BA42B7F47FaBBb689cDB68800DF87Abf4eD0": "Ayabuu",
            },
            functionSigs: {
              "0x6a761202": "function execTransaction(address to,uint256 value,bytes data,uint8 operation,uint256 safeTxGas,uint256 baseGas,uint256 gasPrice,address gasToken,address refundReceiver,bytes signatures)",
              "0x1688f0b9": "function createProxyWithNonce(address _singleton,bytes initializer,uint256 saltNonce)",
              "0xa9059cbb": "function transfer(address recipient,uint256 amount)", // ERC-20
              // "0x4666fc80": "function swapTokensSingleV3ERC20ToERC20(bytes32 _transactionId,string _integrator,string _referrer,address _receiver,uint256 _minAmountOut,tuple _swapData)",
              "0xfe029156": "function swap(address fromToken, address toToken, uint256 amount, uint256 minReturn)",
              "0xb88d4fde": "function safeTransferFrom(address from, address to, uint256 tokenId, bytes _data)", // ERC-721
            },
            version: 10,
          },

          modalSafeAddress: {
            address: null,
          },

          modalSafeTx: {
            item: null,
          },

          modalMethodId: {
            methodId: null,
            data: null,
            contract: null,
            abi: null,
          },

          // TODO: Delete
          modalSafe: {
            chainId: null,
            safeAddressIndex: null,
            safe: null,
            blockNumber: null,
            logIndex: null,
            txHashIndex: null,
            factoryAddressIndex: null,
            factory: null,
            info: {},
            events: {},
          },

          sync: {
            section: null,
            total: null,
            completed: null,
            error: null, // TODO
            halt: false,
          },

          safeTxsSortOptions: [
            // { value: 'addressasc', text: '▲ Addr' },
            // { value: 'addressdsc', text: '▼ Addr' },
            { value: 'blocknumberasc', text: '▲ BlockNumber, ▲ TxIndex' },
            { value: 'blocknumberdsc', text: '▼ BlockNumber, ▼ TxIndex' },
          ],
          safesSortOptions: [
            { value: 'blocknumberasc', text: '▲ BlockNumber, ▲ LogIndex' },
            { value: 'blocknumberdsc', text: '▼ BlockNumber, ▼ LogIndex' },
            { value: 'updatedasc', text: '▲ Updated' },
            { value: 'updateddsc', text: '▼ Updated' },
          ],
          safeEventsSortOptions: [
            { value: 'blocknumberasc', text: '▲ BlockNumber, ▲ LogIndex' },
            { value: 'blocknumberdsc', text: '▼ BlockNumber, ▼ LogIndex' },
          ],
          pageSizes: [
            { value: 2, text: '2' },
            { value: 5, text: '5' },
            { value: 10, text: '10' },
            { value: 15, text: '15' },
            { value: 25, text: '25' },
            { value: 50, text: '50' },
            { value: 100, text: '100' },
            { value: 250, text: '250' },
            { value: 500, text: '500' },
            { value: 1000, text: '1,000' },
          ],

          addressTypeOptions: [
            { value: null, text: 'Unknown' },
            { value: 'safe', text: 'Gnosis Safe' },
            { value: 'safecontracts', text: 'Gnosis Safe Contracts' },
            { value: 'owner', text: 'Gnosis Safe Owner' },
            { value: 'erc20', text: 'ERC-20' },
            { value: 'erc721', text: 'ERC-721' },
            { value: 'erc1155', text: 'ERC-1155' },
          ],

          safesFields: [
            { key: 'index', label: '#', sortable: false, thStyle: 'width: 7%;', tdClass: 'text-truncate' },
            { key: 'blockNumber', label: 'Block # / Log Index', sortable: false, thStyle: 'width: 13%;', tdClass: 'text-truncate' },
            { key: 'safe', label: 'Safe', sortable: false, thStyle: 'width: 20%;', tdClass: 'text-truncate' },
            { key: 'owners', label: 'Owners', sortable: false, thStyle: 'width: 40%;', tdClass: 'text-left' },
            { key: 'threshold', label: 'Threshold', sortable: false, thStyle: 'width: 10%;', tdClass: 'text-truncate' },
            { key: 'factory', label: 'Factory', sortable: false, thStyle: 'width: 10%;', tdClass: 'text-truncate' },
          ],

          safeTxsFields: [
            { key: 'index', label: '#', sortable: false, thStyle: 'width: 7%;', tdClass: 'text-truncate' },
            { key: 'when', label: 'When', sortable: false, thStyle: 'width: 13%;', tdClass: 'text-truncate' },
            { key: 'tx', label: 'Transaction & Events', sortable: false, thStyle: 'width: 65%;', tdClass: 'text-left' },
            { key: 'balance', label: 'Balance', sortable: false, thStyle: 'width: 15%;', tdClass: 'text-left' },
          ],

          db: {
            name: "gnosissafeexplorer088k",
            version: 1,
            schemaDefinition: {
              safeFactoryEvents: '[chainId+blockNumber+logIndex],safe,factory',
              safeEvents: '[chainId+blockNumber+logIndex],safe,type',
              cache: '&objectName',
            },
            updated: null,
          },
        },

        // --- COMPUTED ---
        computed: {

          factoriesToVersion() {
            const result = {};
            for (const [version, versionData] of Object.entries(SAFE_ADDRESSES)) {
              for (const [contractName, address] of Object.entries(this.chainId && versionData[this.chainId] || {})) {
                if (contractName == "proxy_factory" || contractName == "safe_proxy_factory") {
                  result[address] = parseInt(version);
                }
              }
            }
            return result;
          },
          versionToFactories() {
            const result = {};
            for (const [version, versionData] of Object.entries(SAFE_ADDRESSES)) {
              for (const [contractName, address] of Object.entries(this.chainId && versionData[this.chainId] || {})) {
                if (contractName == "proxy_factory" || contractName == "safe_proxy_factory") {
                  result[version] = address;
                }
              }
            }
            return result;
          },

          safeContractNames() {
            const results = {};
            for (const [version, versionData] of Object.entries(SAFE_ADDRESSES)) {
              for (const [chainId, chainData] of Object.entries(versionData)) {
                for (const [contractName, address] of Object.entries(chainData)) {
                  // console.log(version + "/" + chainId + "/" + contractName + " => " + address);
                  // results[address] = contractName + " v" + version + "/" + chainId + " " + address.substring(0, 8) + '...' + address.slice(-6);
                  results[address] = contractName + ":" + version;
                }
              }
            }
            return results;
          },

          modalSafeOwners() {
            const results = {};
            let i = 1;
            for (const owner of (this.modalSafe.info.owners || [])) {
              results[owner] = "Owner #" + i++;
            }
            return results;
          },

          filteredSortedSafes() {
            // console.log(moment().format("HH:mm:ss") + " filteredSortedSafes - filter: " + this.settings.safesTable.filter);
            const results = [];
            // const filter = this.settings.safesTable.filter != null && this.settings.safesTable.filter.length > 0 ? this.settings.safesTable.filter : null;
            let regex = null;
            if (this.settings.safesTable.filter != null && this.settings.safesTable.filter.length > 0) {
              try {
                regex = new RegExp(this.settings.safesTable.filter, 'i');
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " filteredSortedSafes - regex error: " + e.message);
                regex = new RegExp(/thequickbrowndogjumpsoverthelazyfox/, 'i');
              }
            }
            for (const safe of this.safes) {
              let include = true;
              if (regex) {
                if (!(regex.test(safe[0]))) {
                  include = false;
                }
              }
              // if (filter) {
              //   // const safeAddress = this.addresses[safe.safeAddressIndex];
              //   if (safe[0].indexOf(filter) < 0) {
              //     include = false;
              //   }
              // }
              if (include) {
                results.push(safe);
              }
            }
            if (this.settings.safesTable.sortOption == 'blocknumberasc') {
              results.sort((a, b) => {
                if (a[7] == b[7]) {
                  return a[8] - b[8];
                } else {
                  return a[7] - b[7];
                }
              });
            } else if (this.settings.safesTable.sortOption == 'blocknumberdsc') {
              results.sort((a, b) => {
                if (a[7] == b[7]) {
                  return b[8] - a[8];
                } else {
                  return b[7] - a[7];
                }
              });
            } else if (this.settings.safesTable.sortOption == 'updatedasc') {
              results.sort((a, b) => {
                if (a[9] == b[9]) {
                  if (a[7] == b[7]) {
                    return a[8] - b[8];
                  } else {
                    return a[7] - b[7];
                  }
                } else {
                  return a[9] - b[9];
                }
              });
            } else if (this.settings.safesTable.sortOption == 'updateddsc') {
              results.sort((a, b) => {
                if (a[9] == b[9]) {
                  if (a[7] == b[7]) {
                    return b[8] - a[8];
                  } else {
                    return b[7] - a[7];
                  }
                } else {
                  return b[9] - a[9];
                }
              });
            }
            return results;
          },
          pagedFilteredSortedSafes() {
            const results = this.filteredSortedSafes.slice((this.settings.safesTable.currentPage - 1) * this.settings.safesTable.pageSize, this.settings.safesTable.currentPage * this.settings.safesTable.pageSize);
            // console.log(moment().format("HH:mm:ss") + " pagedFilteredSortedSafes - results: " + JSON.stringify(results, null, 2));
            return results;
          },

          filteredSortedSafeTxs() {
            // console.log(moment().format("HH:mm:ss") + " filteredSortedSafeTxs - safe: " + this.settings.safe);
            const results = [];
            // const filter = this.settings.safeTxsTable.filter != null && this.settings.safeTxsTable.filter.length > 0 ? this.settings.safeTxsTable.filter : null;
            let regex = null;
            if (this.settings.safeTxsTable.filter != null && this.settings.safeTxsTable.filter.length > 0) {
              try {
                regex = new RegExp(this.settings.safeTxsTable.filter, 'i');
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " filteredSortedSafeTxs - regex error: " + e.message);
                regex = new RegExp(/thequickbrowndogjumpsoverthelazyfox/, 'i');
              }
            }
            if (this.settings.safe == this.safeData.address) {
              for (const [blockNumber, blockData] of Object.entries(this.safeData.blocks || {})) {
                for (const [txIndex, txData] of Object.entries(blockData.txs || {})) {
                  let include = true;
                  const safeLogs = [];
                  const addresses = {};
                  if (txData.tx && txData.tx.from && !(txData.tx.from in addresses)) {
                    addresses[txData.tx.from] = 1;
                  }
                  if (txData.tx && txData.tx.to && !(txData.tx.to in addresses)) {
                    addresses[txData.tx.to] = 1;
                  }
                  for (const [logIndex, logData] of Object.entries(txData.logs || {})) {
                    if (!(logData.address in addresses)) {
                      addresses[logData.address] = 1;
                    }
                    safeLogs.push({
                      logIndex,
                      address: logData.address,
                      name: logData.name,
                      signature: logData.signature,
                      parameters: logData.parameters,
                    });
                    for (const [index, parameter] of logData.parameters.entries()) {
                      if (parameter.type == "address") {
                        if (!(parameter.value in addresses)) {
                          addresses[parameter.value] = 1;
                        }
                      } else if (parameter.type == "address[]") {
                        for (const a of parameter.value) {
                          if (!(a in addresses)) {
                            addresses[a] = 1;
                          }
                        }
                      }
                    }
                  }
                  let junk = false;
                  for (const address of Object.keys(addresses)) {
                    if (address in this.settings.junk) {
                      junk = true;
                      break;
                    }
                  }
                  if (this.settings.safeTxsTable.junkFilter) {
                    if (this.settings.safeTxsTable.junkFilter == 'junk' && !junk) {
                      include = false;
                    } else if (this.settings.safeTxsTable.junkFilter == 'excludejunk' && junk) {
                      include = false;
                    }
                  }
                  // console.log(blockNumber + "/" + txHash + "/" + logIndex + " => " + JSON.stringify(logData).substring(0, 1000) + "...");
                  // if (regex) {
                  //   if (!(regex.test(safe[0]))) {
                  //     include = false;
                  //   }
                  // }
                  // if (filter) {
                  //   // const safeAddress = this.addresses[safe.safeAddressIndex];
                  //   if (safe[0].indexOf(filter) < 0) {
                  //     include = false;
                  //   }
                  // }
                  if (include) {
                    safeLogs.sort((a, b) => {
                      return a.logIndex - b.logIndex;
                    });
                    const info = inferTxInfo(txData, this.safeData.address, this.settings.functionSigs);
                    // console.log(moment().format("HH:mm:ss") + " filteredSortedSafeTxs - info: " + JSON.stringify(info, null, 2));
                    results.push({
                      blockNumber,
                      timestamp: blockData.timestamp,
                      balance: blockData.balance,
                      txIndex,
                      txHash: txData.txHash,
                      nonce: txData.nonce,
                      tx: txData.tx,
                      txReceipt: txData.txReceipt,
                      safeLogs,
                      junk,
                      info,
                    });
                  }
                }
              }
            }
            if (this.settings.safeTxsTable.sortOption == 'blocknumberasc') {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return a.txIndex - b.txIndex;
                } else {
                  return a.blockNumber - b.blockNumber;
                }
              });
            } else if (this.settings.safeTxsTable.sortOption == 'blocknumberdsc') {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return b.txIndex - a.txIndex;
                } else {
                  return b.blockNumber - a.blockNumber;
                }
              });
            }
            return results;
          },
          pagedFilteredSortedSafeTxs() {
            const results = this.filteredSortedSafeTxs.slice((this.settings.safeTxsTable.currentPage - 1) * this.settings.safeTxsTable.pageSize, this.settings.safeTxsTable.currentPage * this.settings.safeTxsTable.pageSize);
            // console.log(moment().format("HH:mm:ss") + " pagedFilteredSortedSafeTxs - results: " + JSON.stringify(results, null, 2));
            return results;
          },

          safe() {
            // console.log(moment().format("HH:mm:ss") + " safe - this.settings.safe: " + this.settings.safe);
            const safeIndex = this.safesIndex[this.settings.safe] || null;
            const results = safeIndex && this.safes[safeIndex] || {};
            // console.log(moment().format("HH:mm:ss") + " safe - results: " + JSON.stringify(results));
            return results;
          },
        },

        // --- METHODS ---
        methods: {

          viewAddress(address) {
            this.modalSafeAddress.address = address;
            this.$bvModal.show('modal-safeaddress');
          },

          viewMethodId(methodId, data, contract) {
            this.modalMethodId.methodId = methodId;
            this.modalMethodId.data = data;
            this.modalMethodId.contract = contract;
            this.$bvModal.show('modal-methodid');
          },

          modalMethodId_search() {
            if (this.modalMethodId.abi) {
              try {
                const interface = new ethers.utils.Interface(this.modalMethodId.abi);
                for (const f of interface.format(ethers.utils.FormatTypes.full)) {
                  if (f.substring(0, 8) == "function") {
                    const functionSig = interface.getFunction(f.substring(9,));
                    const methodId = interface.getSighash(functionSig);
                    if (this.modalMethodId.methodId == methodId) {
                      return f;
                    }
                  }
                }
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " modalMethodId_search - error: " + e.message);
              }
              return "Not found";
            }
            return null;
          },

          modalMethodId_add() {
            const function_ = this.modalMethodId_search();
            Vue.set(this.settings.functionSigs, this.modalMethodId.methodId, this.modalMethodId_search());
            this.$bvModal.hide('modal-methodid');
            this.saveSettings();
          },

          safeTxsRowSelected(item) {
            if (item && item.length > 0) {
              this.modalSafeTx.item = item[0];
              this.$bvModal.show('modal-safetx');
              this.$refs.safeTxsTable.clearSelected();
            }
          },

          async safesRowSelected(item) {
            if (item && item.length > 0) {
              console.log(moment().format("HH:mm:ss") + " safesRowSelected - item: " + JSON.stringify(item));
              this.settings.safe = item[0][0];
              this.settings.page = 'safe';
              this.saveSettings();
              this.$refs.safesTable.clearSelected();
              await this.syncSafe();
            }
          },

          async syncSafe() {

            async function syncSafe_processSafeAndTokenLogs(section, fromBlock, toBlock, logs) {
              console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - section: " + section + ", fromBlock: " + fromBlock + ", toBlock: " + toBlock + ", logs.length: " + logs.length);
              for (const log of logs) {
                if (!log.removed) {
                  // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - log: " + JSON.stringify(log, null, 2));
                  let event = null;
                  let safeABIVersion = null;
                  const nonce = safeData.nonce;
                  if (log.topics[0] in SAFE_TOPICS_BY_TOPICSLENGTH) {
                    if (log.topics.length in SAFE_TOPICS_BY_TOPICSLENGTH[log.topics[0]]) {
                      safeABIVersion = SAFE_TOPICS_BY_TOPICSLENGTH[log.topics[0]][log.topics.length];
                    }
                  }
                  let logData = null;
                  if (safeABIVersion) {
                    // Safe + Safe Factory events
                    if (safeABIVersion == 130) {
                      logData = safeInterface130.parseLog(log);
                    } else if (safeABIVersion == 141) {
                      logData = safeInterface141.parseLog(log);
                    } else {
                      console.error(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - No Interface - log: " + JSON.stringify(log));
                    }
                    if (logData) {
                      const parameters = [];
                      for (let [i, value] of logData.args.entries()) {
                        const type = logData.eventFragment.inputs[i].type;
                        if (type == "uint256") {
                          value = ethers.BigNumber.from(value).toString();
                        }
                        parameters.push({ value, name: logData.eventFragment.inputs[i].name, type });
                      }
                      event = {
                        version: safeABIVersion,
                        name: logData.name,
                        signature: logData.signature,
                        parameters,
                      };
                      if (logData.name == "ExecutionSuccess" || logData.name == "ExecutionFailure") {
                        safeData.nonce++;
                      }
                    }
                  } else {
                    // ERC-20, ERC-721 and ERC-1155 Transfer* events
                    // ERC-20 & ERC-721 Transfer(indexed address from, indexed address to, indexed uint256 id)
                    // [ '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', null, accountAs32Bytes ],
                    // // ERC-1155 TransferSingle(indexed address _operator, indexed address _from, indexed address _to, uint256 _id, uint256 _value)
                    // [ '0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62', null, accountAs32Bytes, null ],
                    // // ERC-1155 TransferBatch(indexed address operator, indexed address from, indexed address to, uint256[] ids, uint256[] values)
                    // [ '0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb', null, accountAs32Bytes, null ],
                    if (log.topics[0] == "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef") {
                      if (log.topics.length == 3) {
                        // ERC-20 Transfer(indexed address from, indexed address to, uint256 tokens)
                        const from = ethers.utils.getAddress('0x' + log.topics[1].substring(26));
                        const to = ethers.utils.getAddress('0x' + log.topics[2].substring(26));
                        const tokens = ethers.BigNumber.from(log.data).toString();
                        // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - ERC-20.Transfer[" + log.topics.length + "] - from: " + from.substring(0, 12) + ", to: " + to.substring(0, 12) + ", tokens: " + tokens);
                        event = {
                          version: 20,
                          name: "Transfer",
                          signature: "Transfer(address,address,tokens)",
                          parameters: [
                            { "name": "from", value: from, type: "address" },
                            { "name": "to", value: to, type: "address" },
                            { "name": "tokens", value: tokens, type: "uint256" },
                          ],
                        };
                      } else if (log.topics.length == 4) {
                        // ERC-721 Transfer(indexed address from, indexed address to, indexed uint256 tokenId)
                        const from = ethers.utils.getAddress('0x' + log.topics[1].substring(26));
                        const to = ethers.utils.getAddress('0x' + log.topics[2].substring(26));
                        const tokenId = ethers.BigNumber.from(log.topics[3]).toString();
                        // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - ERC-721.Transfer[" + log.topics.length + "] - from: " + from.substring(0, 12) + ", to: " + to.substring(0, 12) + ", tokenId: " + tokenId);
                        event = {
                          version: 721,
                          name: "Transfer",
                          signature: "Transfer(address,address,tokens)",
                          parameters: [
                            { "name": "from", value: from, type: "address" },
                            { "name": "to", value: to, type: "address" },
                            { "name": "tokenId", value: tokenId, type: "uint256" },
                          ],
                        };
                      }

                    } else if (log.topics[0] == "0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62") {
                      // ERC-1155 TransferSingle(indexed address operator, indexed address from, indexed address to, uint256 tokenId, uint256 tokens)
                      const logData = erc1155Interface.parseLog(log);
                      const [operator, from, to, tokenId, tokens] = logData.args;
                      // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - ERC-1155.Transfer[" + log.topics.length + "] - operator: " + operator + ", from: " + from.substring(0, 12) + ", to: " + to.substring(0, 12) + ", tokenId: " + tokenId + ", tokens: " + tokens);
                      event = {
                        version: 1155,
                        name: "TransferSingle",
                        signature: "TransferSingle(address,address,address,uint256,uint256)",
                        parameters: [
                          { "name": "operator", value: operator, type: "address" },
                          { "name": "from", value: from, type: "address" },
                          { "name": "to", value: to, type: "address" },
                          { "name": "tokenId", value: ethers.BigNumber.from(tokenId).toString(), type: "uint256" },
                          { "name": "tokens", value: ethers.BigNumber.from(tokens).toString(), type: "uint256" },
                        ],
                      };

                    } else if (log.topics[0] == "0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb") {
                      // ERC-1155 TransferBatch(indexed address operator, indexed address from, indexed address to, uint256[] tokenIds, uint256[] tokenss)
                      const logData = erc1155Interface.parseLog(log);
                      const [operator, from, to, tokenIds, tokenss] = logData.args;
                      // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - ERC-1155.TransferBatch[" + log.topics.length + "] - operator: " + operator + ", from: " + from.substring(0, 12) + ", to: " + to.substring(0, 12) + ", tokenIds: " + JSON.stringify(tokenIds) + ", tokenss: " + JSON.stringify(tokenss));
                      // TODO: Test, and convert tokenIds and tokenss from BigNumbers to Strings
                      event = {
                        version: 1155,
                        name: "TransferBatch",
                        signature: "TransferBatch(address,address,address,uint256[],uint256[])",
                        parameters: [
                          { "name": "operator", value: operator, type: "address" },
                          { "name": "from", value: from, type: "address" },
                          { "name": "to", value: to, type: "address" },
                          { "name": "tokenIds", value: tokenIds, type: "uint256[]" },
                          { "name": "tokenss", value: tokenss, type: "uint256[]" },
                        ],
                      };
                    } else {
                      console.error(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - Transfers/No Interface[" + log.topics.length + "] - log: " + JSON.stringify(log));
                    }
                    if (event) {
                      if (!(log.address in safeData.tokens)) {
                        safeData.tokens[log.address] = {
                          type: event.version,
                          name: null, // ERC-20 symbol; ERC-721 and ERC-1155 name
                          description: null, // ERC-20 name; ERC-721 and ERC-1155 name
                          slug: null, // ERC-721 and ERC-1155 collection slug
                          image: null, // ERC-721 and ERC-1155 collection image
                          decimals: null,
                          tokens: {},
                        };
                        // console.log(moment().format("HH:mm:ss") + " syncSafe_processSafeAndTokenLogs - added token: " + log.address + " => " + JSON.stringify(safeData.tokens[log.address], null, 2));
                      }
                      if ((event.version == 721 || event.version == 1155) && !(event.tokenId in safeData.tokens[log.address].tokens)) {
                        let tokenId = null;
                        if (event.version == 721) {
                          tokenId = event.parameters[2].value;
                          safeData.tokens[log.address].tokens[tokenId] = {
                            name: null,
                            description: null,
                            image: null,
                          };
                        } else {
                          if (event.name == "TransferSingle") {
                            tokenId = event.parameters[3].value;
                            safeData.tokens[log.address].tokens[tokenId] = {
                              name: null,
                              description: null,
                              image: null,
                            };
                          } else {
                            // TODO: test and refactor
                            for (const tokenId of event.parameters[3]) {
                              safeData.tokens[log.address].tokens[tokenId] = {
                                name: null,
                                description: null,
                                image: null,
                              };
                            }
                          }
                        }
                      }
                    }
                  }
                  if (event) {
                    if (!(log.blockNumber in safeData.blocks)) {
                      safeData.blocks[log.blockNumber] = {
                        timestamp: null,
                        balance: null,
                        txs: {},
                      };
                    }
                    if (!(log.transactionIndex in safeData.blocks[log.blockNumber].txs)) {
                      safeData.blocks[log.blockNumber].txs[log.transactionIndex] = {
                        txHash: log.transactionHash,
                        logs: {},
                        nonce,
                        tx: null,
                        txReceipt: null,
                      };
                    }
                    if (!(log.logIndex in safeData.blocks[log.blockNumber].txs[log.transactionIndex].logs)) {
                      safeData.blocks[log.blockNumber].txs[log.transactionIndex].logs[log.logIndex] = {
                        address: log.address,
                        ...event,
                      };
                    }
                  }
                  t.sync.completed++;
                }
              }
            }

            async function syncSafe_getSafeAndTokenLogsFromRange(section, fromBlock, toBlock) {
              console.log(moment().format("HH:mm:ss") + " syncSafe_getSafeAndTokenLogsFromRange - section: " + section + ", fromBlock: " + fromBlock + ", toBlock: " + toBlock);
              const sections = [
                // All Safe events
                // // 1.1.1 event ProxyCreation(Proxy proxy)
                // '0xa38789425dbeee0239e16ff2d2567e31720127fbc6430758c1a4efc6aef29f80',
                // // 1.3.0 event ProxyCreation(GnosisSafeProxy proxy, address singleton)
                // // 1.4.1 event ProxyCreation(SafeProxy indexed proxy, address singleton)
                // '0x4f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235',
                //
                // // 1.0.0 & 1.1.1 No SafeSetup
                // // 1.3.0 & 1.4.1 event SafeSetup(address indexed initiator, address[] owners, uint256 threshold, address initializer, address fallbackHandler);
                // '0x141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8',
                // // 1.3.0 & 1.4.1 event ApproveHash(bytes32 indexed approvedHash, address indexed owner);
                // '0xf2a0eb156472d1440255b0d7c1e19cc07115d1051fe605b0dce69acfec884d9c',
                // // 1.3.0 & 1.4.1 event SignMsg(bytes32 indexed msgHash)
                // '0xe7f4675038f4f6034dfcbbb24c4dc08e4ebf10eb9d257d3d02c0f38d122ac6e4',
                // // 1.3.0 event ExecutionFailure(bytes32 txHash, uint256 payment)
                // // 1.4.1 event ExecutionFailure(bytes32 indexed txHash, uint256 payment)
                // '0x23428b18acfb3ea64b08dc0c1d296ea9c09702c09083ca5272e64d115b687d23',
                // // 1.3.0 event ExecutionSuccess(bytes32 txHash, uint256 payment)
                // // 1.4.1 event ExecutionSuccess(bytes32 indexed txHash, uint256 payment)
                // '0x442e715f626346e8c54381002da614f62bee8d27386535b2521ec8540898556e',
                //
                // // 1.3.0 event ChangedFallbackHandler(address handler)
                // // 1.4.1 event ChangedFallbackHandler(address indexed handler)
                // '0x5ac6c46c93c8d0e53714ba3b53db3e7c046da994313d7ed0d192028bc7c228b0',
                //
                // // 1.3.0 event ChangedGuard(address guard)
                // // 1.4.1 event ChangedGuard(address indexed guard)
                // '0x1151116914515bc0891ff9047a6cb32cf902546f83066499bcf8ba33d2353fa2',
                //
                // // 1.3.0 event EnabledModule(address module)
                // // 1.4.1 event EnabledModule(address indexed module)
                // '0xecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440',
                // // 1.3.0 event DisabledModule(address module)
                // // 1.4.1 event DisabledModule(address indexed module)
                // '0xaab4fa2b463f581b2b32cb3b7e3b704b9ce37cc209b5fb4d77e593ace4054276',
                // // 1.3.0 & 1.4.1 event ExecutionFromModuleSuccess(address indexed module)
                // '0x6895c13664aa4f67288b25d7a21d7aaa34916e355fb9b6fae0a139a9085becb8',
                // // 1.3.0 & 1.4.1 event ExecutionFromModuleFailure(address indexed module)
                // '0xacd2c8702804128fdb0db2bb49f6d127dd0181c13fd45dbfe16de0930e2bd375',
                //
                // // 1.3.0 event AddedOwner(address owner)
                // // 1.4.1 event AddedOwner(address indexed owner)
                // '0x9465fa0c962cc76958e6373a993326400c1c94f8be2fe3a952adfa7f60b2ea26',
                // // 1.3.0 event RemovedOwner(address owner)
                // // 1.4.1 event RemovedOwner(address indexed owner)
                // '0xf8d49fc529812e9a7c5c50e69c20f0dccc0db8fa95c98bc58cc9a4f1c1299eaf',
                // // 1.3.0 & 1.4.1 event ChangedThreshold(uint256 threshold)
                // '0x610f7ff2b304ae8903c3de74c60c6ab1f7d6226b3f52c5161905bb5ad4039c93',
                //
                // // event SafeReceived(address indexed sender, uint256 value);
                // '0x3d0ce9bfc3ed7d6862dbb28b2dea94561fe714a1b4d019aa8af39730d1ad7c3d',
                {
                  address: safeAddress,
                  topics: null,
                },
                // ERC-20 & ERC-721 Transfer(indexed address from, indexed address to, indexed uint256 id)
                // [ '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', safeAddressAsBytes32, null ],
                {
                  address: null,
                  topics: [
                    '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef',
                    safeAddressAsBytes32,
                    null,
                  ],
                },
                // ERC-20 & ERC-721 Transfer(indexed address from, indexed address to, indexed uint256 id)
                // [ '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', null, accountAs32Bytes ],
                // // ERC-1155 TransferSingle(indexed address _operator, indexed address _from, indexed address _to, uint256 _id, uint256 _value)
                // [ '0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62', null, accountAs32Bytes, null ],
                // // ERC-1155 TransferBatch(indexed address operator, indexed address from, indexed address to, uint256[] ids, uint256[] values)
                // [ '0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb', null, accountAs32Bytes, null ],
                {
                  address: null,
                  topics: [[
                      '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef',
                      '0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62',
                      '0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb',
                    ],
                    null,
                    safeAddressAsBytes32,
                  ],
                },
                // // ERC-1155 TransferSingle(indexed address _operator, indexed address _from, indexed address _to, uint256 _id, uint256 _value)
                // [ '0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62', null, null, accountAs32Bytes ],
                // // ERC-1155 TransferBatch(indexed address operator, indexed address from, indexed address to, uint256[] ids, uint256[] values)
                // [ '0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb', null, null, accountAs32Bytes ],
                {
                  address: null,
                  topics: [[
                      '0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62',
                      '0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb',
                    ],
                    null,
                    null,
                    safeAddressAsBytes32,
                  ],
                },
              ];
              try {
                const logs = await provider.getLogs({
                  address: sections[section].address,
                  fromBlock,
                  toBlock,
                  topics: sections[section].topics,
                });
                await syncSafe_processSafeAndTokenLogs(section, fromBlock, toBlock, logs);
                // console.log(moment().format("HH:mm:ss") + " syncSafe_getSafeAndTokenLogsFromRange - logs: " + JSON.stringify(logs, null, 2));
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncSafe_getSafeAndTokenLogsFromRange - Error: " + e.message);
                const mid = parseInt((fromBlock + toBlock) / 2);
                await syncSafe_getSafeAndTokenLogsFromRange(section, fromBlock, mid);
                await syncSafe_getSafeAndTokenLogsFromRange(section, parseInt(mid) + 1, toBlock);
              }
            }

            // console.log(moment().format("HH:mm:ss") + " syncSafe - this.settings.safe: " + this.settings.safe);
            const t = this;
            const db = new Dexie(this.db.name);
            db.version(this.db.version).stores(this.db.schemaDefinition);

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            localStorage.gnosisSafeExplorerChainId = chainId;
            const block = await provider.getBlock();
            const latestBlockNumber = block && block.number || null;
            console.log(moment().format("HH:mm:ss") + " syncSafe - latestBlockNumber: " + latestBlockNumber);
            this.sync.section = "Safe";
            this.sync.total = null;
            this.sync.completed = 0;
            const safeInterface130 = new ethers.utils.Interface(SAFE_ABIS[130].gnosis_safe);
            const safeInterface141 = new ethers.utils.Interface(SAFE_ABIS[141].gnosis_safe);
            const erc1155Interface = new ethers.utils.Interface(ERC1155ABI);

            let safeAddress = null;
            let safeAddressAsBytes32 = null;
            try {
              safeAddress = ethers.utils.getAddress(this.settings.safe);
              safeAddressAsBytes32 = '0x000000000000000000000000' + safeAddress.substring(2, 42).toLowerCase();
            } catch (e) {
            }
            console.log(moment().format("HH:mm:ss") + " syncSafe - safeAddress: " + safeAddress); // + ", safeAddressAsBytes32: " + safeAddressAsBytes32);

            const defaultSafeData = {
              address: safeAddress,
              version: null,
              implementation: null,
              owners: {},
              threshold: null,
              nonce: 0,
              tokens: {},
              blocks: {},
            };
            const safeData = this.settings.devMode ? defaultSafeData : (safeAddress ? (await this.getCachedData("safeData_" + safeAddress, db, chainId, defaultSafeData)) : defaultSafeData);
            // console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 1: " + JSON.stringify(safeData).substring(0, 1000) + "...");

            if (safeAddress && !this.settings.devMode) {
              const allSafesAbi = [
                "function VERSION() public view returns (string)",
                "function getOwners() public view returns (address[] memory)",
                "function getThreshold() public view returns (uint256)",
                "function nonce() public view returns (uint256)",
                "function getStorageAt(uint256 offset, uint256 length) public view returns (bytes memory)",
              ];
              const allSafesContract = new ethers.Contract(safeAddress, allSafesAbi, provider);
              try {
                safeData.version = await allSafesContract.VERSION();
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.version - error: " + e.message);
              }
              this.sync.completed++;
              try {
                safeData.implementation = ethers.utils.getAddress('0x' + (await allSafesContract.getStorageAt(0, 1)).substring(26, 66));
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.implementation - error: " + e.message);
              }
              this.sync.completed++;
              try {
                const owners = await allSafesContract.getOwners();
                safeData.owners = {};
                for (const [index, owner] of owners.entries()) {
                  safeData.owners[owner] = index;
                }
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.owners - error: " + e.message);
              }
              this.sync.completed++;
              try {
                safeData.threshold = parseInt(await allSafesContract.getThreshold());
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.threshold - error: " + e.message);
              }
              this.sync.completed++;
            }

            if (safeAddress) {
              this.sync.section = "Safe Events";
              safeData.nonce = 0;
              await syncSafe_getSafeAndTokenLogsFromRange(0, 0, latestBlockNumber);
              this.sync.section = "Token Events #1";
              await syncSafe_getSafeAndTokenLogsFromRange(1, 0, latestBlockNumber);
              this.sync.section = "Token Events #2";
              await syncSafe_getSafeAndTokenLogsFromRange(2, 0, latestBlockNumber);
              this.sync.section = "Token Events #3";
              await syncSafe_getSafeAndTokenLogsFromRange(3, 0, latestBlockNumber);
              console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 2: " + JSON.stringify(safeData, null, 2).substring(0, 200) + "...");
              await this.saveCacheData("safeData_" + safeAddress, safeData, db, chainId);
              Vue.set(this, 'safeData', structuredClone(safeData));
            }

            if (safeAddress && !this.sync.halt && !this.settings.devMode) {
              this.sync.section = "Timestamps And Balances";
              this.sync.completed = 0;
              this.sync.total = 0;
              for (const [blockNumber, blockData] of Object.entries(safeData.blocks)) {
                if (!blockData.timestamp || !blockData.balance) {
                  this.sync.total++;
                }
              }
              for (const [blockNumber, blockData] of Object.entries(safeData.blocks)) {
                if (!blockData.timestamp || !blockData.balance) {
                  t.sync.completed++;
                }
                if (!blockData.timestamp) {
                  try {
                    const block = await provider.getBlock(parseInt(blockNumber));
                    safeData.blocks[blockNumber].timestamp = parseInt(block.timestamp);
                  } catch (e) {
                    console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.getBlock().timestamp - error: " + e.message);
                  }
                }
                if (!blockData.balance) {
                  try {
                    const balance = await provider.getBalance(safeAddress, parseInt(blockNumber));
                    safeData.blocks[blockNumber].balance = ethers.BigNumber.from(balance).toString();
                  } catch (e) {
                    console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.balance - error: " + e.message);
                  }
                }
                if (this.sync.halt) {
                  break;
                }
              }
              console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 3: " + JSON.stringify(safeData, null, 2).substring(0, 200) + "...");
              await this.saveCacheData("safeData_" + safeAddress, safeData, db, chainId);
              Vue.set(this, 'safeData', structuredClone(safeData));
            }

            if (safeAddress && !this.sync.halt /*&& !this.settings.devMode*/) {
              this.sync.section = "Transactions & Receipts";
              this.sync.completed = 0;
              this.sync.total = 0;
              for (const [blockNumber, blockData] of Object.entries(safeData.blocks)) {
                for (const [txHash, txData] of Object.entries(blockData.txs)) {
                  if (!txData.tx || !txData.txReceipt) {
                    this.sync.total++;
                  }
                }
              }
              for (const [blockNumber, blockData] of Object.entries(safeData.blocks)) {
                for (const [txIndex, txData] of Object.entries(blockData.txs)) {
                  if (!txData.tx && !this.sync.halt) {
                    try {
                      const tx = await provider.getTransaction(txData.txHash);
                      safeData.blocks[blockNumber].txs[txIndex].tx = {
                        blockNumber: tx.blockNumber,
                        type: tx.type || null,
                        from: tx.from,
                        nonce: parseInt(tx.nonce),
                        to: tx.to,
                        value: ethers.BigNumber.from(tx.value).toString(),
                        gasPrice: ethers.BigNumber.from(tx.gasPrice).toString(),
                        maxPriorityFeePerGas: tx.maxPriorityFeePerGas && ethers.BigNumber.from(tx.maxPriorityFeePerGas).toString() || null,
                        gasLimit: parseInt(tx.gasLimit),
                        data: tx.data,
                      };
                    } catch (e) {
                      console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.getTransaction - error: " + e.message);
                    }
                  }
                  if (!txData.txReceipt && !this.sync.halt) {
                    try {
                      const txReceipt = await provider.getTransactionReceipt(txData.txHash);
                      safeData.blocks[blockNumber].txs[txIndex].txReceipt = {
                        // type: parseInt(txReceipt.type),
                        contractAddress: txReceipt.contractAddress,
                        gasUsed: parseInt(txReceipt.gasUsed),
                        cumulativeGasUsed: parseInt(txReceipt.cumulativeGasUsed),
                        effectiveGasPrice: txReceipt.effectiveGasPrice && parseInt(txReceipt.effectiveGasPrice) || null,
                        status: parseInt(txReceipt.status),
                        logs: txReceipt.logs, // TODO: Remove unnecessary fields
                      };
                    } catch (e) {
                      console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.getTransactionReceipt - error: " + e.message);
                    }
                  }
                  t.sync.completed++;
                  if (this.sync.halt) {
                    break;
                  }
                }
              }
              console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 4: " + JSON.stringify(safeData, null, 2).substring(0, 200) + "...");
              await this.saveCacheData("safeData_" + safeAddress, safeData, db, chainId);
              Vue.set(this, 'safeData', structuredClone(safeData));
            }

            if (safeAddress && !this.sync.halt && !this.settings.devMode) {
              this.sync.section = "ERC-20/721/1155 Token Contract";
              this.sync.completed = 0;
              this.sync.total = 0;
              for (const [token, tokenContractData] of Object.entries(safeData.tokens)) {
                if (!tokenContractData.name) {
                  this.sync.total++;
                }
              }
              const ERC_TOKENS_ABI = [
                "function symbol() public view returns (string)",
                "function name() public view returns (string)",
                "function decimals() public view returns (uint8)",
              ];
              for (const [token, tokenContractData] of Object.entries(safeData.tokens)) {
                const ercTokensContract = new ethers.Contract(token, ERC_TOKENS_ABI, provider);
                if (!tokenContractData.name) {
                  try {
                    safeData.tokens[token].name = tokenContractData.type == 20 ? (await ercTokensContract.symbol()) : (await ercTokensContract.name());
                  } catch (e) {
                    console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.ercTokens.name() - error: " + e.message);
                  }
                }
                if (!tokenContractData.description) {
                  try {
                    safeData.tokens[token].description = tokenContractData.type == 20 ? (await ercTokensContract.name()) : safeData.tokens[token].name;
                  } catch (e) {
                    console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.ercTokens.description() - error: " + e.message);
                  }
                }
                if (tokenContractData.type == 20 && !tokenContractData.decimals) {
                  try {
                    safeData.tokens[token].decimals = parseInt(await ercTokensContract.decimals());
                  } catch (e) {
                    console.error(moment().format("HH:mm:ss") + " syncSafe - safeData.ercTokens.decimals() - error: " + e.message);
                  }
                }
                t.sync.completed++;
                if (this.sync.halt) {
                  break;
                }
              }
              // console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 5: " + JSON.stringify(safeData, null, 2).substring(0, 2000) + "...");
              await this.saveCacheData("safeData_" + safeAddress, safeData, db, chainId);
              Vue.set(this, 'safeData', structuredClone(safeData));
            }

            if (safeAddress && !this.sync.halt /*&& this.settings.devMode*/) {
              this.sync.section = "ERC-721/1155 Token Metadata";
              this.sync.completed = 0;
              this.sync.total = 0;
              for (const [token, tokenContractData] of Object.entries(safeData.tokens)) {
                if (tokenContractData.type == 721 || tokenContractData.type == 1155) {
                  for (const [tokenId, tokenData] of Object.entries(tokenContractData.tokens)) {
                    console.log(token + "/" + tokenId + " => " + JSON.stringify(tokenData));
                    if (!tokenContractData.name) {
                      this.sync.total++;
                    }
                  }
                }
              }
              const reservoirData = {};
              let continuation = null;
              do {
                let url = "https://api.reservoir.tools/users/" + safeAddress + "/tokens/v10?limit=200&includeTopBid=true&includeAttributes=true&includeLastSale=true";
                url = url + (continuation != null ? "&continuation=" + continuation : "");
                console.log(moment().format("HH:mm:ss") + " syncSafe - downloadFromReservoir - url: " + url);
                const data = await fetch(url)
                  .then(handleErrors)
                  .then(response => response.json())
                  .catch(function(error) {
                    console.log(moment().format("HH:mm:ss") + " syncSafe - downloadFromReservoir - ERROR: " + error);
                    return {};
                  });
                continuation = data.continuation;
                parseReservoirData(data, reservoirData);
                // TODO: Only works for ETH mainnet
                for (const [reservoirTokenContractAddress, reservoirTokenContractData] of Object.entries(reservoirData[1] || {})) {
                  if (safeData.tokens[reservoirTokenContractAddress]) {
                    safeData.tokens[reservoirTokenContractAddress].slug = reservoirTokenContractData.slug;
                    safeData.tokens[reservoirTokenContractAddress].image = reservoirTokenContractData.image;
                    for (const [reservoirTokenId, reservoirTokenData] of Object.entries(reservoirTokenContractData.tokens)) {
                      if (safeData.tokens[reservoirTokenContractAddress].tokens[reservoirTokenId]) {
                        safeData.tokens[reservoirTokenContractAddress].tokens[reservoirTokenId].name = reservoirTokenData.name;
                        safeData.tokens[reservoirTokenContractAddress].tokens[reservoirTokenId].description = reservoirTokenData.description;
                        safeData.tokens[reservoirTokenContractAddress].tokens[reservoirTokenId].image = reservoirTokenData.image;
                      }
                    }
                  }
                }
                if (continuation != null) {
                  await delay(1000);
                }
              } while (continuation != null);
              console.log(moment().format("HH:mm:ss") + " syncSafe - safeData 6: " + JSON.stringify(safeData, null, 2).substring(0, 10000) + "...");
              await this.saveCacheData("safeData_" + safeAddress, safeData, db, chainId);
              Vue.set(this, 'safeData', safeData);
            }

            db.close();
            this.sync.section = null;
            this.sync.halt = false;
          },

          async syncAllSafesEvents() {

            async function syncAllSafesEvents_processLogs(fromBlock, toBlock, logs) {
              console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - fromBlock: " + fromBlock + ", toBlock: " + toBlock + ", logs.length: " + logs.length);
              const records = [];
              for (const log of logs) {
                if (!log.removed) {
                  // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - log: " + JSON.stringify(log));
                  let event = null;
                  let abiVersion = null;
                  if (log.topics[0] in SAFE_TOPICS_BY_TOPICSLENGTH) {
                    if (log.topics.length in SAFE_TOPICS_BY_TOPICSLENGTH[log.topics[0]]) {
                      abiVersion = SAFE_TOPICS_BY_TOPICSLENGTH[log.topics[0]][log.topics.length];
                    }
                  }
                  // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - abiVersion: " + abiVersion);
                  let logData = null;
                  // Factory events
                  if (log.topics[0] == '0xa38789425dbeee0239e16ff2d2567e31720127fbc6430758c1a4efc6aef29f80' || log.topics[0] == '0x4f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235') {
                    if (abiVersion == 111) {
                      logData = safeFactoryInterface111.parseLog(log);
                      // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - safeFactoryInterface111: " + JSON.stringify(logData, null, 2));
                    } else if (abiVersion == 130) {
                      logData = safeFactoryInterface130.parseLog(log);
                      // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - safeFactoryInterface130: " + JSON.stringify(logData, null, 2));
                    } else if (abiVersion == 141) {
                      logData = safeFactoryInterface141.parseLog(log);
                      // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - safeFactoryInterface141: " + JSON.stringify(logData, null, 2));
                    }
                  // Safe events
                  } else if (abiVersion == 130) {
                    logData = safeInterface130.parseLog(log);
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - logData 130: " + JSON.stringify(logData, null, 2));
                  } else if (abiVersion == 141) {
                    logData = safeInterface141.parseLog(log);
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - logData 141: " + JSON.stringify(logData, null, 2));
                  } else {
                    console.error(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - logData ???: " + JSON.stringify(log));
                  }
                  if (logData) {
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - name: " + logData.name);
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - signature: " + logData.signature + ", abiVersion: " + abiVersion);
                    const parameters = [];
                    for (let [i, value] of logData.args.entries()) {
                      // console.log(i + " => " + value + " " + logData.eventFragment.inputs[i].name + " " + logData.eventFragment.inputs[i].type);
                      const type = logData.eventFragment.inputs[i].type;
                      if (type == "uint256") {
                        value = ethers.BigNumber.from(value).toString();
                      } else if (type == "address[]") {
                        // TODO: Handle indexation of addressesIndex
                      }
                      parameters.push({
                        value,
                        name: logData.eventFragment.inputs[i].name,
                        type,
                      });
                    }
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - parameters: " + JSON.stringify(parameters));
                    event = {
                      type: SAFE_EVENT_TYPES[logData.name],
                      name: logData.name,
                      signature: logData.signature,
                      parameters,
                    };
                    if (!(log.transactionHash in txHashesIndex)) {
                      txHashesIndex[log.transactionHash] = txHashes.length;
                      txHashes.push([log.transactionHash, log.blockNumber, log.transactionIndex]);
                    }
                    const txHashIndex = txHashesIndex[log.transactionHash];
                    if (logData.name == "SafeSetup") {
                      // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - SafeSetup: " + log.address + ", owners: " + JSON.stringify(logData.args[1]) + ", threshold: " + parseInt(logData.args[2]));
                      const factoryVersion = logData.args[0] && t.factoriesToVersion[logData.args[0]] || null;
                      if (factoryVersion) {
                        const ownerList = [];
                        for (const owner of logData.args[1]) {
                          if (!(owner in ownersIndex)) {
                            ownersIndex[owner] = parseInt(owners.length);
                            owners.push(owner);
                          }
                          ownerList.push([ownersIndex[owner], txHashIndex]);
                        }
                        if (!(log.address in safesIndex)) {
                          safesIndex[log.address] = parseInt(safes.length);
                          safes.push([
                            log.address,                 // Address
                            factoryVersion,              // Factory version
                            ownerList,                   // Owners
                            parseInt(logData.args[2]),   // Threshold
                            [],                          // Removed owners
                            null,                        // Factory ProxyCreation event - factory version number
                            txHashIndex,                 // Creation txHash index
                            log.blockNumber,             // Creation Block number
                            log.logIndex,                // Creation logIndex
                            txHashIndex,                 // Latest txHash index
                            // initializer: logData.args[3],
                            // fallbackHandler: logData.args[4],
                          ]);
                        }
                      } else {
                        // console.error(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - SafeSetup not emitted by the configured factories: " + JSON.stringify(log, null, 2));
                      }
                    } else if (logData.name == "ProxyCreation") {
                      // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - ProxyCreation: " + JSON.stringify(logData.args));

                      const factoryVersion = log.address && t.factoriesToVersion[log.address] || null;
                      if (factoryVersion) {
                        if (logData.args[0] in safesIndex) {
                          safesIndex[logData.args[0]][5] = parseInt(t.factoriesToVersion[log.address]);
                        } else {
                          // Create new safe record
                          safesIndex[logData.args[0]] = parseInt(safes.length);
                          safes.push([
                            logData.args[0],             // Address
                            factoryVersion,              // Factory version
                            null,                        // Owners
                            null,                        // Threshold
                            [],                          // Removed owners
                            factoryVersion,              // Factory ProxyCreation event - factory version number
                            txHashIndex,                 // Creation txHash index
                            log.blockNumber,             // Creationi Block number
                            log.logIndex,                // Creation logIndex
                            txHashIndex,                 // Latest txHash index
                            // initializer: logData.args[3],
                            // fallbackHandler: logData.args[4],
                          ]);
                        }
                      } else {
                        // console.error(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - ProxyCreation not emitted by the configured factories: " + JSON.stringify(log, null, 2));
                      }
                    } else if (logData.name == "AddedOwner") {
                      const safeIndex = safesIndex[log.address];
                      if (safeIndex) {
                        if (!(logData.args[0] in ownersIndex)) {
                          ownersIndex[logData.args[0]] = parseInt(owners.length);
                          owners.push(logData.args[0]);
                        }
                        const ownerIndex = ownersIndex[logData.args[0]];
                        const before = safes[safeIndex][2];
                        safes[safeIndex][2] = [...safes[safeIndex][2].filter(e => e[0] != ownerIndex), [ownerIndex, txHashIndex]];
                        safes[safeIndex][9] = txHashIndex;
                        // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - AddedOwner - safeIndex: " + safes[safeIndex][0] + ", ownerIndex: " + ownerIndex + ", before: " + JSON.stringify(before) + ", after: " + JSON.stringify(safes[safeIndex][2]));
                      }

                    } else if (logData.name == "RemovedOwner") {
                      const safeIndex = safesIndex[log.address];
                      const ownerIndex = ownersIndex[logData.args[0]];
                      if (safeIndex && ownerIndex) {
                        // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - RemovedOwner safeIndex: " + safeIndex + ", ownerIndex: " + ownerIndex);
                        const before = safes[safeIndex][2];
                        safes[safeIndex][2] = safes[safeIndex][2].filter(e => e[0] != ownerIndex);
                        safes[safeIndex][9] = txHashIndex;
                        // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - RemovedOwner - safeIndex: " + safes[safeIndex][0] + ", ownerIndex: " + ownerIndex + ", before: " + JSON.stringify(before) + ", after: " + JSON.stringify(safes[safeIndex][2]));
                      }

                    } else if (logData.name == "ChangedThreshold") {
                      const safeIndex = safesIndex[log.address];
                      if (safeIndex) {
                        const before = safes[safeIndex][3];
                        safes[safeIndex][3] = parseInt(logData.args[0]);
                        // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - ChangedThreshold - safeIndex: " + safeIndex + ", threshold: " + parseInt(logData.args[0]) + ", before: " + before + ", after: " + safes[safeIndex][3]);
                      }
                    }
                  }

                  if (event) {
                    records.push({
                      chainId,
                      blockNumber: parseInt(log.blockNumber),
                      txIndex: parseInt(log.transactionIndex),
                    //   txHashIndex,
                      txHash: log.transactionHash,
                      logIndex: parseInt(log.logIndex),
                      address: log.address,
                    //   safeAddressIndex,
                      safe: log.address,
                    //   factoryAddressIndex: addressesIndex[log.address],
                      ...event,
                    });
                  }
                }
              }
              if (records.length) {
                // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - records: " + JSON.stringify(records, null, 2));
                await db.safeEvents.bulkAdd(records).then(function(lastKey) {
                  console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - bulkAdd lastKey: " + JSON.stringify(lastKey));
                  }).catch(Dexie.BulkError, function(e) {
                    // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_processLogs - bulkAdd e: " + JSON.stringify(e.failures, null, 2));
                  });
              }
            }

            async function syncAllSafesEvents_getLogsFromRange(fromBlock, toBlock) {
              console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_getLogsFromRange - fromBlock: " + fromBlock + ", toBlock: " + toBlock);
              try {
                if (!t.sync.halt) {
                  const logs = await provider.getLogs({
                    address: null,
                    fromBlock,
                    toBlock,
                    topics: [[
                        // 1.1.1 event ProxyCreation(Proxy proxy)
                        // '0xa38789425dbeee0239e16ff2d2567e31720127fbc6430758c1a4efc6aef29f80',
                        // 1.3.0 event ProxyCreation(GnosisSafeProxy proxy, address singleton)
                        // 1.4.1 event ProxyCreation(SafeProxy indexed proxy, address singleton)
                        // '0x4f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235',

                        // // 1.0.0 & 1.1.1 No SafeSetup
                        // // 1.3.0 & 1.4.1 event SafeSetup(address indexed initiator, address[] owners, uint256 threshold, address initializer, address fallbackHandler);
                        '0x141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8',
                        // // 1.3.0 & 1.4.1 event ApproveHash(bytes32 indexed approvedHash, address indexed owner);
                        // '0xf2a0eb156472d1440255b0d7c1e19cc07115d1051fe605b0dce69acfec884d9c',
                        // // 1.3.0 & 1.4.1 event SignMsg(bytes32 indexed msgHash)
                        // '0xe7f4675038f4f6034dfcbbb24c4dc08e4ebf10eb9d257d3d02c0f38d122ac6e4',
                        // // 1.3.0 event ExecutionFailure(bytes32 txHash, uint256 payment)
                        // // 1.4.1 event ExecutionFailure(bytes32 indexed txHash, uint256 payment)
                        // '0x23428b18acfb3ea64b08dc0c1d296ea9c09702c09083ca5272e64d115b687d23',
                        // // 1.3.0 event ExecutionSuccess(bytes32 txHash, uint256 payment)
                        // // 1.4.1 event ExecutionSuccess(bytes32 indexed txHash, uint256 payment)
                        // '0x442e715f626346e8c54381002da614f62bee8d27386535b2521ec8540898556e',
                        //
                        // // 1.3.0 event ChangedFallbackHandler(address handler)
                        // // 1.4.1 event ChangedFallbackHandler(address indexed handler)
                        // '0x5ac6c46c93c8d0e53714ba3b53db3e7c046da994313d7ed0d192028bc7c228b0',
                        //
                        // // 1.3.0 event ChangedGuard(address guard)
                        // // 1.4.1 event ChangedGuard(address indexed guard)
                        // '0x1151116914515bc0891ff9047a6cb32cf902546f83066499bcf8ba33d2353fa2',
                        //
                        // // 1.3.0 event EnabledModule(address module)
                        // // 1.4.1 event EnabledModule(address indexed module)
                        // '0xecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440',
                        // // 1.3.0 event DisabledModule(address module)
                        // // 1.4.1 event DisabledModule(address indexed module)
                        // '0xaab4fa2b463f581b2b32cb3b7e3b704b9ce37cc209b5fb4d77e593ace4054276',
                        // // 1.3.0 & 1.4.1 event ExecutionFromModuleSuccess(address indexed module)
                        // '0x6895c13664aa4f67288b25d7a21d7aaa34916e355fb9b6fae0a139a9085becb8',
                        // // 1.3.0 & 1.4.1 event ExecutionFromModuleFailure(address indexed module)
                        // '0xacd2c8702804128fdb0db2bb49f6d127dd0181c13fd45dbfe16de0930e2bd375',

                        // // 1.3.0 event AddedOwner(address owner)
                        // // 1.4.1 event AddedOwner(address indexed owner)
                        '0x9465fa0c962cc76958e6373a993326400c1c94f8be2fe3a952adfa7f60b2ea26',
                        // // 1.3.0 event RemovedOwner(address owner)
                        // // 1.4.1 event RemovedOwner(address indexed owner)
                        '0xf8d49fc529812e9a7c5c50e69c20f0dccc0db8fa95c98bc58cc9a4f1c1299eaf',
                        // // 1.3.0 & 1.4.1 event ChangedThreshold(uint256 threshold)
                        '0x610f7ff2b304ae8903c3de74c60c6ab1f7d6226b3f52c5161905bb5ad4039c93',

                        // // event SafeReceived(address indexed sender, uint256 value);
                        // '0x3d0ce9bfc3ed7d6862dbb28b2dea94561fe714a1b4d019aa8af39730d1ad7c3d',
                      ],
                    ],
                  });
                  await syncAllSafesEvents_processLogs(fromBlock, toBlock, logs);
                  // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents_getLogsFromRange - logs: " + JSON.stringify(logs, null, 2));
                  t.sync.completed = toBlock;
                }
              } catch (e) {
                console.error(moment().format("HH:mm:ss") + " syncAllSafesEvents_getLogsFromRange - Error: " + e.message);
                const mid = parseInt((fromBlock + toBlock) / 2);
                await syncAllSafesEvents_getLogsFromRange(fromBlock, mid);
                await syncAllSafesEvents_getLogsFromRange(parseInt(mid) + 1, toBlock);
              }
            }

            const t = this;
            const db = new Dexie(this.db.name);
            db.version(this.db.version).stores(this.db.schemaDefinition);

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            localStorage.gnosisSafeExplorerChainId = chainId;
            const block = await provider.getBlock();
            const latestBlockNumber = block && block.number || null;
            console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - latestBlockNumber: " + latestBlockNumber);
            this.sync.section = "Syncing";
            this.sync.total = latestBlockNumber;
            this.sync.completed = 0;
            const safeFactoryInterface111 = new ethers.utils.Interface(SAFE_ABIS[111].proxy_factory);
            const safeFactoryInterface130 = new ethers.utils.Interface(SAFE_ABIS[130].proxy_factory);
            const safeFactoryInterface141 = new ethers.utils.Interface(SAFE_ABIS[141].proxy_factory);
            const safeInterface130 = new ethers.utils.Interface(SAFE_ABIS[130].gnosis_safe);
            const safeInterface141 = new ethers.utils.Interface(SAFE_ABIS[141].gnosis_safe);

            const addresses = await this.getCachedData('addresses', db, chainId, []);
            const addressesIndex = await this.getCachedData('addressesIndex', db, chainId, {});
            const txHashes = await this.getCachedData('txHashes', db, chainId, []);
            const txHashesIndex = await this.getCachedData('txHashesIndex', db, chainId, {});
            const owners = await this.getCachedData('owners', db, chainId, []);
            const ownersIndex = await this.getCachedData('ownersIndex', db, chainId, {});
            const safes = await this.getCachedData('safes', db, chainId, []);
            const safesIndex = await this.getCachedData('safesIndex', db, chainId, {});
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - versionToFactories: " + JSON.stringify(this.versionToFactories));
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - addresses 1: " + JSON.stringify(addresses).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - addressesIndex 1: " + JSON.stringify(addressesIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - txHashes 1: " + JSON.stringify(txHashes).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - txHashesIndex 1: " + JSON.stringify(txHashesIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - owners 1: " + JSON.stringify(owners).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - ownersIndex 1: " + JSON.stringify(ownersIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - safes 1: " + JSON.stringify(safes).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - safesIndex 1: " + JSON.stringify(safesIndex).substring(0, 1000) + "...");

            const latest = await db.safeEvents.where('[chainId+blockNumber+logIndex]').between([chainId, Dexie.minKey, Dexie.minKey],[chainId, Dexie.maxKey, Dexie.maxKey]).last();
            console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - latest: " + (latest && JSON.stringify(latest).substring(0, 100) || null));
            const startBlock = this.settings.devMode ? (latestBlockNumber - 1000000) : (latest ? parseInt(latest.blockNumber) + 1: 0);
            this.sync.completed = startBlock;
            console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - startBlock: " + startBlock);
            await syncAllSafesEvents_getLogsFromRange(startBlock, latestBlockNumber);

            console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - saveCacheData BEGIN");
            await this.saveCacheData("addresses", addresses, db, chainId);
            await this.saveCacheData("addressesIndex", addressesIndex, db, chainId);
            await this.saveCacheData("txHashes", txHashes, db, chainId);
            await this.saveCacheData("txHashesIndex", txHashesIndex, db, chainId);
            await this.saveCacheData("owners", owners, db, chainId);
            await this.saveCacheData("ownersIndex", ownersIndex, db, chainId);
            await this.saveCacheData("safes", safes, db, chainId);
            await this.saveCacheData("safesIndex", safesIndex, db, chainId);
            console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - saveCacheData END");

            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - addresses 2: " + JSON.stringify(addresses).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - addressesIndex 2: " + JSON.stringify(addressesIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - txHashes 2: " + JSON.stringify(txHashes).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - txHashesIndex 2: " + JSON.stringify(txHashesIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - owners 2: " + JSON.stringify(owners).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - ownersIndex 2: " + JSON.stringify(ownersIndex).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - safes 2: " + JSON.stringify(safes).substring(0, 1000) + "...");
            // console.log(moment().format("HH:mm:ss") + " syncAllSafesEvents - safesIndex 2: " + JSON.stringify(safesIndex).substring(0, 1000) + "...");
            db.close();
            await this.loadCurrentData();
            this.sync.section = null;
            this.sync.halt = false;
          },

          async loadCurrentData() {
            console.log(moment().format("HH:mm:ss") + " loadCurrentData - BEGIN");
            const DB_PROCESSING_BATCH_SIZE = 50000;
            const db = new Dexie(this.db.name);
            db.version(this.db.version).stores(this.db.schemaDefinition);
            const chainId = this.chainId;

            let safeAddress = null;
            let safeAddressAsBytes32 = null;
            try {
              safeAddress = ethers.utils.getAddress(this.settings.safe);
            } catch (e) {
            }

            for (const name of ['addresses', 'addressesIndex', 'txHashes', 'txHashesIndex', 'owners', 'ownersIndex', 'safes', 'safesIndex'/*, 'timestamps'*/]) {
              const data = await this.getCachedData(name, db, chainId, name.endsWith("Index") ? {} : []);
              Vue.set(this, name, data);
              // console.log(moment().format("HH:mm:ss") + " loadCurrentData - " + name); // + ": " + JSON.stringify(data).substring(0, 1000) + "...");
            }

            const safeData = safeAddress ? (await this.getCachedData("safeData_" + safeAddress, db, chainId, {})) : {};
            Vue.set(this, 'safeData', safeData);
            // console.log(moment().format("HH:mm:ss") + " loadCurrentData - safeData: " + JSON.stringify(safeData, null, 2).substring(0, 2000) + "...");

            // const timestamps = await this.getCachedData("timestamps", db, chainId, {});
            // console.log(moment().format("HH:mm:ss") + " loadCurrentData - timestamps: " + JSON.stringify(timestamps).substring(0, 1000) + "...");
            // Vue.set(this, "timestamps", timestamps);

            // let rows = 0;
            // let done = false;
            // const safes = {};
            // do {
            //   let data;
            //   if (this.settings.safesTable.filter && this.settings.safesTable.filter.length > 2) {
            //     data = await db.safeFactoryEvents.where('safe').startsWithIgnoreCase(this.settings.safesTable.filter).offset(rows).limit(DB_PROCESSING_BATCH_SIZE).toArray();
            //   } else {
            //     data = await db.safeFactoryEvents.where('[chainId+blockNumber+logIndex]').between([Dexie.minKey, Dexie.minKey, Dexie.minKey],[Dexie.maxKey, Dexie.maxKey, Dexie.maxKey]).offset(rows).limit(DB_PROCESSING_BATCH_SIZE).toArray();
            //   }
            //   console.log(moment().format("HH:mm:ss") + " loadCurrentData - data.length: " + data.length + ", first[0..9]: " + JSON.stringify(data.slice(0, 10).map(e => e.blockNumber + '.' + e.logIndex )));
            //   for (const item of data) {
            //     if (!(item.chainId in safes)) {
            //       safes[item.chainId] = {};
            //     }
            //     if (!(item.safeAddressIndex in safes[item.chainId])) {
            //       safes[item.chainId][item.safeAddressIndex] = {
            //         blockNumber: item.blockNumber,
            //         logIndex: item.logIndex,
            //         txHashIndex: item.txHashIndex,
            //         factoryAddressIndex: item.factoryAddressIndex,
            //       };
            //     }
            //   }
            //   rows = parseInt(rows) + data.length;
            //   done = data.length < DB_PROCESSING_BATCH_SIZE;
            // } while (!done);
            // console.log(moment().format("HH:mm:ss") + " loadCurrentData - safes: " + JSON.stringify(safes));
            // Vue.set(this, 'safes', safes);
            db.close();
            console.log(moment().format("HH:mm:ss") + " loadCurrentData - END");
          },

          saveSettings() {
            // console.log(moment().format("HH:mm:ss") + " saveSettings: " + JSON.stringify(this.settings, null, 2));
            localStorage.gnosisSafeExplorerSettings = JSON.stringify(this.settings);
          },

          async processNewBlock(blockNumber) {
            console.log(moment().format("HH:mm:ss") + " processNewBlock[" + this.chainId + "] #" + this.commify0(blockNumber) + ", latest #" + this.commify0(this.blockNumber) + " @ " + moment.unix(this.timestamp).format("YYYY-MM-DD HH:mm:ss") + " " + moment.unix(this.timestamp).fromNow());
          },
          async halt() {
            this.sync.halt = true;
            console.log(moment().format("HH:mm:ss") + " halt()");
          },
          commify0(n) {
            if (n != null) {
              return Number(n).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return null;
          },
          formatTokens(token, tokens, precision = 9) {
            if (token == "eth") {
              try {
                if (precision == 0) {
                  return tokens ? ethers.utils.formatEther(tokens).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") : null;
                } else {
                  return tokens ? parseFloat(ethers.utils.formatEther(tokens)).toFixed(precision) : null;
                }
              } catch (err) {
              }
              return tokens.toFixed(precision);
            } else {
              if (token in this.settings.addresses) {
                const decimals = this.settings.addresses[token].decimals || 18;
                try {
                  if (precision == 0) {
                    return tokens ? ethers.utils.formatUnits(tokens, decimals).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") : null;
                  } else {
                    return tokens ? parseFloat(ethers.utils.formatUnits(tokens, decimals)).toFixed(precision) : null;
                  }
                } catch (err) {
                }
                return tokens.toFixed(precision);
              }
            }
            return tokens;
          },
          formatETH(e, precision = 9) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatEther(e).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") : null;
              } else {
                return e ? parseFloat(ethers.utils.formatEther(e)).toFixed(precision).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatDecimals(e, decimals = 18) {
            return e ? ethers.utils.formatUnits(e, decimals) : null;
          },
          formatTimestamp(ts) {
            if (ts != null) {
              // if (this.settings.reportingDateTime == 1) {
              //   return moment.unix(ts).utc().format("YYYY-MM-DD HH:mm:ss");
              // } else {
                return moment.unix(ts).format("YYYY-MM-DD HH:mm:ss");
              // }
            }
            return null;
          },
          formatTimeDiff(unixtime) {
            if (!unixtime) {
              return "";
            } else {
              return moment.unix(unixtime).fromNow();
            }
          },

          safe_updateName(address, name) {
            if (name && name.length > 0) {
              Vue.set(this.settings.names, address, name);
            } else {
              Vue.delete(this.settings.names, address);
            }
            this.saveSettings();
          },
          safe_updateDecimals(address, decimals) {
            if (!decimals || decimals.length == 0) {
              Vue.delete(this.settings.decimals, address);
            } else {
              if (parseInt(decimals) >= 0 && parseInt(decimals) <= 18) {
                Vue.set(this.settings.decimals, address, parseInt(decimals));
              }
            }
            this.saveSettings();
          },
          safe_toggleJunk(item) {
            if (item && this.settings.junk[item]) {
              Vue.delete(this.settings.junk, item);
            } else {
              Vue.set(this.settings.junk, item, true);
            }
            this.saveSettings();
          },
          safe_lookupName(a) {
            if (a) {
              if ((a in this.settings.names) && this.settings.names[a].length > 0) {
                return this.settings.names[a];
              } else if (a == this.settings.safe) {
                return "This Safe";
              } else if (a in this.safeData.tokens) {
                return this.safeData.tokens[a] && this.safeData.tokens[a].name || (a.substring(0, 8) + '...' + a.slice(-6));
              } else if (a in this.safeContractNames) {
                return this.safeContractNames[a];
              } else if (a in this.safeData.owners) {
                return "Owner #" + this.safeData.owners[a] + " " + a.substring(2, 6).toUpperCase();
              } else {
                return a.substring(0, 8) + '...' + a.slice(-6);
              }
            }
            return null;
          },
          safe_lookupNameType(a) {
            if (a) {
              if (a == this.settings.safe) {
                return "safe";
              } else if (a in this.safeData.tokens) {
                return "erc" + this.safeData.tokens[a].type;
              } else if (a in this.safeData.owners) {
                return "owner";
              } else if (a in this.safeContractNames) {
                return 'safecontracts';
              }
            }
            return null;
          },
          safe_lookupDecimals(a) {
            if (a && (a in this.safeData.tokens) && this.safeData.tokens[a].type == 20) {
              if (this.settings.decimals[a]) {
                return this.settings.decimals[a];
              } else {
                return this.safeData.tokens[a].decimals;
              }
            }
            return 0;
          },
          // TODO: Delete
          safe_lookupAddress(a) {
            console.log(moment().format("HH:mm:ss") + " safe_lookupAddress: " + a);
            if ((a in this.safeData.tokens)) {
              const token = this.safeData.tokens[a];
              return {
                address: a,
                type: token.type,
                name: token.name,
                description: token.description,
                decimals: token.decimals,
              };
            }
            return { address: a };
          },

          async resetData() {
            this.$bvModal.msgBoxConfirm('Reset all data?', {
                title: 'Please Confirm',
                size: 'sm',
                buttonSize: 'sm',
                okVariant: 'danger',
                okTitle: 'Yes',
                cancelTitle: 'No',
                footerClass: 'p-2',
                hideHeaderClose: false,
                // centered: true
              })
              .then(async value1 => {
                if (value1) {
                  event.preventDefault();
                  delete localStorage.gnosisSafeExplorerChainId;
                  delete localStorage.gnosisSafeExplorerSettings;
                  const db = new Dexie(this.db.name);
                  db.version(this.db.version).stores(this.db.schemaDefinition);
                  // let status = await db.safeFactoryEvents.clear();
                  // status = await db.safeEvents.clear();
                  // status = await db.cache.clear();
                  const status = await db.delete();
                  db.close();
                  alert('This page will reload 5 seconds after you click OK.')
                  setTimeout(function() {
                    window.location.reload();
                  }, 5000);
                }
              })
              .catch(err => {
                // An error occurred
              });
          },

          lookupAddress(a) {
            // if (a.toString().length < 42) {
            //   a = this.addresses[a];
            // }
            return a;
          },
          lookupName(a) {
            // if (a.toString().length < 42) {
            //   if (this.chainId && (a in this.safesIndex[this.chainId])) {
            //     a = "Safe " + this.addresses[a].substring(0, 8) + '...' + this.addresses[a].slice(-6);
            //   } else {
            //     a = this.addresses[a];
            //   }
            // } else {
            //   if (this.chainId && (this.addresses[a] in this.safesIndex[this.chainId])) {
            //     a = "Safe " + a.substring(0, 8) + '...' + a.slice(-6);
            //   }
            // }
            // if (a in this.safeContractNames) {
            //   a = this.safeContractNames[a];
            // } else if (a in this.modalSafeOwners) {
            //   a = this.modalSafeOwners[a] + " " + a.substring(0, 8) + '...' + a.slice(-6);
            // }
            return a;
          },

          async saveCacheData(name, data, db, chainId) {
            // console.log(moment().format("HH:mm:ss") + " saveCacheData - name: " + name + ", chainId: " + chainId);
            await db.cache.put({ objectName: name + "_" + chainId, object: data }).then (function() {
              }).catch(function(error) {
                console.error(moment().format("HH:mm:ss") + " saveCacheData - error: " + error);
              });
          },

          async getCachedData(name, db, chainId, empty) {
            // console.log(moment().format("HH:mm:ss") + " getCachedData - name: " + name + ", chainId: " + chainId);
            const dataItems = await db.cache.where("objectName").equals(name + "_" + chainId).toArray();
            // console.log(moment().format("HH:mm:ss") + " getCachedData - dataItems: " + JSON.stringify(dataItems).substring(0, 1000) + "...");
            if (dataItems.length == 1) {
              // console.log(moment().format("HH:mm:ss") + " getCachedData - " + name + ": " + JSON.stringify(dataItems[0].object).substring(0, 1000) + "...");
              return dataItems[0].object;
            } else {
              // console.log(moment().format("HH:mm:ss") + " getCachedData - " + name + ": " + JSON.stringify(empty));
              return empty;
            }
          },

          nameOrShortAddress(address, length = 0) {
            let result = null;
            if (address == "eth") {
              return "ETH";
            }
            if (address in this.settings.addresses) {
              result = this.settings.addresses[address].name;
            }
            if (!result) {
              if (address in CUSTOMNAMES) {
                result = CUSTOMNAMES[address][1];
              } else if (address) {
                // if (address.match(/0x[a-f0-9]{40}/g)) {
                  result = address.substring(0, 6) + '...' + address.slice(-4);
                // } else {
                //   result = address;
                // }
              }
            }
            return result;
          },
          addressDescription(address) {
            const accounts = this.accounts[this.chainId] || {};
            if (address in accounts) {
              result = "address=" + address;
              for (let key of ['type', 'customType', 'symbol', 'name', 'customName', 'decimals', 'customDecimals', 'source']) {
                if (key in accounts[address] && accounts[address][key]) {
                  result = result + "; " + key + "=" + accounts[address][key];
                }
              }
            } else {
              result = address;
            }
            return result;
          },
          copyToClipboard(str) {
            navigator.clipboard.writeText(str);
          },
          async connectToWeb3() {
            if (!window.ethereum) {
              this.connected = false;
            } else {
              try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.connected = window.ethereum.isConnected();
              } catch (e) {
                console.log("window.ethereum.request error: " + e.message);
                this.connected = false;
              }
            }
            if (!this.connected) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, for web3 data retrieval. And refresh!");
            } else {
              const t = this;
              function handleChainChanged(_chainId) {
                t.chainId = _chainId;
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleChainChanged - this.chainId: " + t.chainId);
                alert('Ethereum chain has changed - reloading this page.')
                window.location.reload();
              }
              window.ethereum.on('chainChanged', handleChainChanged);
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              async function handleAccountsChanged(accounts) {
                const signer = provider.getSigner();
                t.coinbase = await signer.getAddress();
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleAccountsChanged: " + t.coinbase);
              }
              window.ethereum.on('accountsChanged', handleAccountsChanged);
              async function handleNewBlock(blockNumber) {
                if (!t.blockNumber || blockNumber > t.blockNumber) {
                  const block = await provider.getBlock("latest");
                  t.blockNumber = block.number;
                  t.timestamp = block.timestamp;
                  await t.processNewBlock(blockNumber);
                }
              }
              provider.on("block", handleNewBlock);
              const signer = provider.getSigner();
              this.coinbase = await signer.getAddress();
              const network = await provider.getNetwork();
              this.chainId = network.chainId;
              console.log(moment().format("HH:mm:ss") + " connectToWeb3[" + this.chainId + "]");
            }
          },
        },

        // --- MOUNTED ---
        mounted() {
          // (async() => {
          //   await this.connectToWeb3();
          // })();
          if ('gnosisSafeExplorerChainId' in localStorage) {
            this.chainId = localStorage.gnosisSafeExplorerChainId;
            // console.log(moment().format("HH:mm:ss") + " mounted - this.chainId: " + this.chainId);
          }
          // if ('gnosisSafeExplorerCoinbase' in localStorage) {
          //   this.coinbase = localStorage.gnosisSafeExplorerCoinbase;
          // }
          if ('gnosisSafeExplorerSettings' in localStorage) {
            const tempSettings = JSON.parse(localStorage.gnosisSafeExplorerSettings);
            if ('version' in tempSettings && tempSettings.version == this.settings.version) {
              this.settings = tempSettings;
              if (this.settings.safesTable.currentPage > 1) {
                this.settings.safesTable.currentPage = 1;
              }
              // console.log(moment().format("HH:mm:ss") + " mounted - this.settings: " + JSON.stringify(this.settings, null, 2).substring(0, 200));
            }
          }
          (async() => {
            await this.loadCurrentData();
          })();
        },
      })
    </script>
  </body>
</html>
