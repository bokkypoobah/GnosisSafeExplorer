<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GnosisSafeExplorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="GnosisSafeExplorer (c) Bok Consulting Pty Ltd 2025" />
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/dexie.js"></script>
    <script src="globals.js"></script>

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="https://bokkypoobah.github.io/GnosisSafeExplorer/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/fknchad_FkqVTzBaUAAiE8x_nobg.png" v-b-popover.hover.bottom="'gm'" class="ml-0"></b-avatar>
            <font size="-1" v-b-popover.hover.bottom="'gm gm gm'">GnosisSafeExplorer</font>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-button v-if="!web3.connected" size="sm" variant="outline-primary" class="ml-5 mr-1" @click="web3Connect('connect');" v-b-popover.hover.bottom="'Connect to web3'">{{ 'Connect' }}</b-button>
            <b-button v-if="web3.connected" size="sm" variant="outline-primary" class="ml-5 mr-1" @click="web3Connect('disconnect');" v-b-popover.hover.bottom="'Disconnect from web3'">{{ web3.coinbase && web3.coinbase.substring(0, 10) }}</b-button>
          </b-navbar-nav>
        </b-navbar>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {
          provider: null,
          web3: {
            connected: null,
            chainId: null,
            coinbase: null,
            blockNumber: null,
            timestamp: null,
          },
        },

        // --- COMPUTED ---
        computed: {
        },

        // --- METHODS ---
        methods: {

          // --- WEB3STUFF ---
          async web3Connect(action) {
            if (!this.provider) {
              this.provider = new ethers.providers.Web3Provider(window.ethereum);
            }
            if (action == 'disconnect') {
              if (this.web3.connected) {
                this.web3.connected = false;
                this.provider.removeAllListeners();
                this.provider = null;
              }
            } else {
              if (!window.ethereum) {
                this.web3.connected = false;
              } else {
                try {
                  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                  this.web3.connected = window.ethereum.isConnected();
                } catch (e) {
                  console.error(now() + " web3Connect - window.ethereum.request error: " + e.message);
                  this.web3.connected = false;
                }
              }
              if (!this.web3.connected) {
                alert("Please load this dapp in a web3-enabled browser like Brave, or use the web3 extension like Rabby or MetaMask");
              } else {
                window.ethereum.on('chainChanged', this.web3HandleChainChanged);
                window.ethereum.on('accountsChanged', this.web3HandleAccountsChanged);
                const network = await this.provider.getNetwork();
                this.web3.chainId = parseInt(network.chainId);
                const block = await this.provider.getBlock("latest");
                this.web3.blockNumber = block.number;
                this.web3.timestamp = block.timestamp;
                const signer = this.provider.getSigner();
                this.web3.coinbase = await signer.getAddress();
                this.provider.on("block", this.web3HandleNewBlock);
                await this.web3HandleNewBlock(0);
              }
            }
            console.log(now() + " web3Connect: " + this.web3.chainId + ":" + this.web3.blockNumber + " @ " + formatLocalTime(this.web3.timestamp) + "; " + (this.web3.coinbase && this.web3.coinbase.substring(0, 10)) + "; " + (this.web3.connected ? "connected" : "disconnected"));
            localStorage.gnosisSafeExplorerWeb3 = JSON.stringify(this.web3);
          },
          async web3HandleChainChanged(_chainId) {
            this.web3.chainId = parseInt(_chainId);
            localStorage.gnosisSafeExplorerWeb3 = JSON.stringify(this.web3);
            alert('Web3 network changed. This page will reload 5 seconds after you click OK.')
            setTimeout(function() {
              window.location.reload();
            }, 5000);
          },
          async web3HandleAccountsChanged(accounts) {
            const signer = this.provider.getSigner();
            this.web3.coinbase = await signer.getAddress();
            localStorage.gnosisSafeExplorerWeb3 = JSON.stringify(this.web3);
          },
          async web3HandleNewBlock(blockNumber) {
            if (!this.web3.blockNumber || blockNumber > this.web3.blockNumber) {
              const block = await this.provider.getBlock("latest");
              this.web3.blockNumber = block.number;
              this.web3.timestamp = block.timestamp;
              if (blockNumber >= this.web3.blockNumber) {
                await this.web3ProcessLatestBlock();
                localStorage.gnosisSafeExplorerWeb3 = JSON.stringify(this.web3);
              }
            }
          },
          async web3ProcessLatestBlock() {
            console.log(now() + " web3ProcessLatestBlock: " + this.web3.chainId + ":" + this.web3.blockNumber + " @ " + formatLocalTime(this.web3.timestamp) + "; " + (this.web3.coinbase && this.web3.coinbase.substring(0, 10)) + "; " + (this.web3.connected ? "connected" : "disconnected"));
          },
        },

        // --- MOUNTED ---
        mounted() {
          if ('gnosisSafeExplorerWeb3' in localStorage) {
            this.web3 = JSON.parse(localStorage.gnosisSafeExplorerWeb3);
            console.log(now() + " mounted: " + this.web3.chainId + ":" + this.web3.blockNumber + " @ " + formatLocalTime(this.web3.timestamp) + "; " + (this.web3.coinbase && this.web3.coinbase.substring(0, 10)) + "; " + (this.web3.connected ? "connected" : "disconnected"));
            if (this.web3.connected) {
              (async() => {
                await this.web3Connect('connect');
              })();
            }
          }

        },
      })
    </script>
  </body>
</html>
